import{a as L}from"./chunk-VRCZJENY.js";import{$ as P,J as l,K as B,M as C,N as d,O as x,P as b,Q as p,S as y,U as g,V as $,W as f,Y as w,Z as A,_ as S}from"./chunk-WLUU74ML.js";import{_ as z,a as i,b as m,da as E,f as c}from"./chunk-3D7XR5P5.js";var G=class R{firestore=E(B);companyService=E(P);authService=E(L);currentCompanyId=null;currentCompany=null;initializeCompanyContext(){return c(this,null,function*(){try{let e=this.companyService.getCompanySubdomain();return!e||(this.currentCompany=yield this.companyService.getCompanyBySubdomain(e),!this.currentCompany)?null:(this.currentCompanyId=this.currentCompany.id,this.currentCompany)}catch{return null}})}getCurrentCompany(){return this.currentCompany}getCurrentCompanyId(){return this.currentCompanyId}setCompanyContext(e){this.currentCompany=e,this.currentCompanyId=e.id}getBoards(e){return c(this,null,function*(){try{let t=this.currentCompanyId;if(!t)try{yield this.initializeCompanyContext(),t=this.currentCompanyId}catch{return[]}if(!t)return[];try{let r=d(this.firestore,"companies",t,"boards"),a=(yield y(r)).docs.map(s=>m(i({id:s.id},s.data()),{companyId:t}));if(a.length===0)try{let s=d(this.firestore,"users",e,"boards");a=(yield y(s)).docs.map(h=>m(i({id:h.id},h.data()),{companyId:t}))}catch{}return a=a.filter(s=>(s.status||"active")==="active"),a}catch{return[]}}catch{return[]}})}createBoard(e,t){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let r=d(this.firestore,"companies",this.currentCompanyId,"boards"),o=m(i({},t),{companyId:this.currentCompanyId,owner:e,ownerEmail:"",status:"active",createdAt:l()});return yield C(r,o)}catch(r){throw console.error("Erro ao criar quadro:",r),r}})}updateBoard(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let o=p(this.firestore,"companies",this.currentCompanyId,"boards",t);return yield w(o,r)}catch(o){throw console.error("Erro ao atualizar quadro:",o),o}})}deleteBoard(e,t){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let r=p(this.firestore,"companies",this.currentCompanyId,"boards",t);return yield b(r)}catch(r){throw console.error("Erro ao excluir quadro:",r),r}})}getColumns(e,t){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)return console.error("Contexto da empresa n\xE3o inicializado"),[];let r=d(this.firestore,"companies",this.currentCompanyId,"boards",t,"columns"),o=f(r,$("order"));return(yield y(o)).docs.map(s=>m(i({id:s.id},s.data()),{companyId:this.currentCompanyId,boardId:t}))}catch(r){return console.error("Erro ao buscar colunas:",r),[]}})}createColumn(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let o=d(this.firestore,"companies",this.currentCompanyId,"boards",t,"columns"),a=m(i({},r),{companyId:this.currentCompanyId,boardId:t,createdAt:l(),updatedAt:l()});return yield C(o,a)}catch(o){throw console.error("Erro ao criar coluna:",o),o}})}updateColumn(e,t,r,o){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let a=p(this.firestore,"companies",this.currentCompanyId,"boards",t,"columns",r);return yield w(a,o)}catch(a){throw console.error("Erro ao atualizar coluna:",a),a}})}deleteColumn(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let o=p(this.firestore,"companies",this.currentCompanyId,"boards",t,"columns",r);return yield b(o)}catch(o){throw console.error("Erro ao excluir coluna:",o),o}})}getLeads(e,t){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)return console.error("Contexto da empresa n\xE3o inicializado"),[];let r=d(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads");return(yield y(r)).docs.map(a=>m(i({id:a.id},a.data()),{companyId:this.currentCompanyId,boardId:t}))}catch(r){return console.error("Erro ao buscar leads:",r),[]}})}createLead(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let o=d(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads"),a=m(i({},r),{companyId:this.currentCompanyId,boardId:t,createdAt:l(),movedToCurrentColumnAt:l()});return yield C(o,a)}catch(o){throw console.error("Erro ao criar lead:",o),o}})}updateLead(e,t,r,o){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let a=p(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads",r);return yield w(a,o)}catch(a){throw console.error("Erro ao atualizar lead:",a),a}})}deleteLead(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let o=p(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads",r);return yield b(o)}catch(o){throw console.error("Erro ao excluir lead:",o),o}})}moveLead(e,t,r,o){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let a=p(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads",r),s={columnId:o,movedToCurrentColumnAt:l()};return yield w(a,s)}catch(a){throw console.error("Erro ao mover lead:",a),a}})}subscribeToBoards(e,t){return this.currentCompanyId?this.performBoardsSubscription(t):(this.initializeCompanyContext().then(()=>{this.currentCompanyId&&this.performBoardsSubscription(t)}),()=>{})}performBoardsSubscription(e){if(!this.currentCompanyId)return e([]),()=>{};let t=d(this.firestore,"companies",this.currentCompanyId,"boards");return g(t,r=>{let o=r.docs.map(a=>m(i({id:a.id},a.data()),{companyId:this.currentCompanyId})).filter(a=>(a.status||"active")==="active");e(o)})}subscribeToColumns(e,t,r){return this.currentCompanyId?this.performColumnsSubscription(t,r):(this.initializeCompanyContext().then(()=>{this.currentCompanyId&&this.performColumnsSubscription(t,r)}),()=>{})}performColumnsSubscription(e,t){if(!this.currentCompanyId)return t([]),()=>{};let r=d(this.firestore,"companies",this.currentCompanyId,"boards",e,"columns"),o=f(r,$("order"));return g(o,a=>{let s=a.docs.map(n=>m(i({id:n.id},n.data()),{companyId:this.currentCompanyId,boardId:e}));t(s)})}subscribeToLeads(e,t,r){return this.currentCompanyId?this.performLeadsSubscription(t,r):(this.initializeCompanyContext().then(()=>{this.currentCompanyId&&this.performLeadsSubscription(t,r)}),()=>{})}performLeadsSubscription(e,t){if(!this.currentCompanyId)return t([]),()=>{};let r=d(this.firestore,"companies",this.currentCompanyId,"boards",e,"leads");return g(r,o=>{let a=o.docs.map(s=>m(i({id:s.id},s.data()),{companyId:this.currentCompanyId,boardId:e}));t(a)})}updateMultipleLeads(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let o=S(this.firestore);return r.forEach(a=>{let s=p(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads",a.leadId);o.update(s,a.data)}),yield o.commit()}catch(o){throw console.error("Erro ao atualizar m\xFAltiplos leads:",o),o}})}addLeadHistory(e,t,r,o){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)throw new Error("Contexto da empresa n\xE3o inicializado");let a=d(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads",r,"history"),s=m(i({},o),{timestamp:l()});return yield C(a,s)}catch(a){throw console.error("Erro ao adicionar hist\xF3rico do lead:",a),a}})}getLeadHistory(e,t,r){return c(this,null,function*(){try{if(this.currentCompanyId||(yield this.initializeCompanyContext()),!this.currentCompanyId)return console.error("Contexto da empresa n\xE3o inicializado"),[];let o=d(this.firestore,"companies",this.currentCompanyId,"boards",t,"leads",r,"history"),a=f(o,$("timestamp","desc"));return(yield y(a)).docs.map(n=>i({id:n.id},n.data()))}catch(o){return console.error("Erro ao buscar hist\xF3rico do lead:",o),[]}})}createPhaseFormConfig(e,t,r){return c(this,null,function*(){let o=d(this.firestore,`users/${e}/boards/${t}/phaseFormConfigs`),a=m(i({},r),{createdAt:l(),updatedAt:l()});return yield C(o,a)})}updatePhaseFormConfig(e,t,r,o){return c(this,null,function*(){let a=p(this.firestore,`users/${e}/boards/${t}/phaseFormConfigs/${r}`),s=m(i({},o),{updatedAt:l()});return yield w(a,s)})}getPhaseFormConfig(e,t,r){return c(this,null,function*(){let o=d(this.firestore,`users/${e}/boards/${t}/phaseFormConfigs`),a=f(o,A("columnId","==",r)),s=yield y(a);if(!s.empty){let n=s.docs[0];return i({id:n.id},n.data())}return null})}deletePhaseFormConfig(e,t,r){return c(this,null,function*(){let o=p(this.firestore,`users/${e}/boards/${t}/phaseFormConfigs/${r}`);return yield b(o)})}getOutboxEmails(e,t){return c(this,null,function*(){let r=d(this.firestore,`users/${e}/boards/${t}/mail`),o=f(r,$("createdAt","desc"));return(yield y(o)).docs.map(s=>i({id:s.id},s.data())).filter(s=>s.to)})}createOutboxEmail(e,t,r){return c(this,null,function*(){let o=d(this.firestore,`users/${e}/boards/${t}/mail`),a=m(i({},r),{createdAt:l(),updatedAt:l()});return yield C(o,a)})}updateOutboxEmail(e,t,r,o){return c(this,null,function*(){let a=p(this.firestore,`users/${e}/boards/${t}/mail/${r}`),s=m(i({},o),{updatedAt:l()});return yield w(a,s)})}deleteOutboxEmail(e,t,r){return c(this,null,function*(){let o=p(this.firestore,`users/${e}/boards/${t}/mail/${r}`);return yield b(o)})}subscribeToOutboxEmails(e,t,r){let o=d(this.firestore,`users/${e}/boards/${t}/mail`),a=f(o,$("createdAt","desc"));return g(a,s=>{let n=s.docs.map(u=>i({id:u.id},u.data())).filter(u=>u.to);r(n)})}getEmailTemplates(e,t){return c(this,null,function*(){try{let r=e?`users/${e}/boards/${t}/emailTemplates`:`boards/${t}/emailTemplates`;console.log("Buscando templates em:",r);let o=d(this.firestore,r),s=(yield y(o)).docs.map(n=>i({id:n.id},n.data()));return console.log(`Templates encontrados: ${s.length} itens`),s}catch(r){return console.error("Erro ao buscar templates:",r),[]}})}createEmailTemplate(e,t,r){return c(this,null,function*(){let o=d(this.firestore,`users/${e}/boards/${t}/emailTemplates`),a=m(i({},r),{boardId:t,createdAt:l(),updatedAt:l()});return console.log("Criando template em:",`users/${e}/boards/${t}/emailTemplates`,a),yield C(o,a)})}updateEmailTemplate(e,t,r,o){return c(this,null,function*(){let a=p(this.firestore,`users/${e}/boards/${t}/emailTemplates/${r}`),s=m(i({},o),{boardId:t,updatedAt:l()});return console.log("Atualizando template em:",`users/${e}/boards/${t}/emailTemplates/${r}`,s),yield w(a,s)})}deleteEmailTemplate(e,t,r){return c(this,null,function*(){let o=p(this.firestore,`users/${e}/boards/${t}/emailTemplates/${r}`);return yield b(o)})}subscribeToEmailTemplates(e,t,r){console.log(`Iniciando subscri\xE7\xE3o de templates para boardId: ${t}`);let o=x(this.firestore,"emailTemplates"),a=f(o,A("boardId","==",t));return g(a,s=>{let n=s.docs.map(u=>i({id:u.id,path:u.ref.path},u.data()));console.log(`Templates encontrados via collectionGroup para boardId: ${t}:`,n),r(n)},s=>{console.error("Erro ao subscrever templates via collectionGroup, tentando estrutura users:",s);let n=d(this.firestore,`users/${e}/boards/${t}/emailTemplates`),u=f(n);return g(u,h=>{let I=h.docs.map(v=>i({id:v.id},v.data()));console.log(`Templates encontrados (fallback users) para userId: ${e}, boardId: ${t}:`,I),r(I)},h=>{console.error("Erro ao subscrever templates (fallback users):",h),r([])})})}getAutomations(e,t){return c(this,null,function*(){try{console.log("Buscando automa\xE7\xF5es para userId:",e,"boardId:",t);try{let r=`users/${e}/boards/${t}/automations`;console.log("Tentando caminho:",r);let o=d(this.firestore,r),s=(yield y(o)).docs.map(n=>i({id:n.id},n.data()));if(s.length>0)return console.log(`Automa\xE7\xF5es encontradas em users/{userId}/boards/{boardId}/automations: ${s.length} itens`),s}catch(r){console.log("Erro ao buscar em users/{userId}/boards/{boardId}/automations:",r)}try{let r=`boards/${t}/automations`;console.log("Tentando caminho alternativo:",r);let o=d(this.firestore,r),s=(yield y(o)).docs.map(n=>i({id:n.id},n.data()));if(s.length>0)return console.log(`Automa\xE7\xF5es encontradas em boards/{boardId}/automations: ${s.length} itens`),s}catch(r){console.log("Erro ao buscar em boards/{boardId}/automations:",r)}try{console.log("Tentando buscar usando collectionGroup");let r=x(this.firestore,"automations"),s=(yield y(r)).docs.map(n=>i({id:n.id,path:n.ref.path},n.data())).filter(n=>n.path.split("/").includes(t));return console.log(`Automa\xE7\xF5es encontradas via collectionGroup: ${s.length} itens`),s}catch(r){console.log("Erro ao buscar via collectionGroup:",r)}return console.log("Nenhuma automa\xE7\xE3o encontrada"),[]}catch(r){return console.error("Erro geral ao buscar automa\xE7\xF5es:",r),[]}})}createAutomation(e,t,r){return c(this,null,function*(){let o=d(this.firestore,`users/${e}/boards/${t}/automations`),a=m(i({},r),{boardId:t,createdAt:l(),updatedAt:l(),active:!0});return console.log("Criando automa\xE7\xE3o em:",`users/${e}/boards/${t}/automations`,a),yield C(o,a)})}updateAutomation(e,t,r,o){return c(this,null,function*(){let a=p(this.firestore,`users/${e}/boards/${t}/automations/${r}`),s=m(i({},o),{boardId:t,updatedAt:l()});return console.log("Atualizando automa\xE7\xE3o em:",`users/${e}/boards/${t}/automations/${r}`,s),yield w(a,s)})}deleteAutomation(e,t,r){return c(this,null,function*(){let o=p(this.firestore,`users/${e}/boards/${t}/automations/${r}`);return console.log("Excluindo automa\xE7\xE3o:",`users/${e}/boards/${t}/automations/${r}`),yield b(o)})}subscribeToAutomationHistory(e,t,r,o){console.log("Subscribing to automation history for:",{userId:e,boardId:t,automationId:r});let a=d(this.firestore,`users/${e}/boards/${t}/automationHistory`),s=f(a,A("automationId","==",r));return g(s,n=>{let u=n.docs.map(h=>i({id:h.id},h.data()));console.log(`Hist\xF3rico de automa\xE7\xE3o encontrado: ${u.length} itens`),o(u)},n=>{console.error("Erro ao buscar hist\xF3rico de automa\xE7\xE3o:",n);let u=d(this.firestore,`boards/${t}/automationHistory`),h=f(u,A("automationId","==",r));return g(h,I=>{let v=I.docs.map(T=>i({id:T.id},T.data()));console.log(`Hist\xF3rico de automa\xE7\xE3o (estrutura alternativa): ${v.length} itens`),o(v)},I=>{console.error("Erro ao buscar hist\xF3rico de automa\xE7\xE3o (estrutura alternativa):",I),o([])})})}addAutomationHistoryItem(e,t,r){return c(this,null,function*(){try{let o=d(this.firestore,`users/${e}/boards/${t}/automationHistory`),a=yield C(o,m(i({},r),{timestamp:new Date,createdAt:new Date}));return console.log("Item de hist\xF3rico de automa\xE7\xE3o adicionado:",a.id),a.id}catch(o){throw console.error("Erro ao adicionar item de hist\xF3rico de automa\xE7\xE3o:",o),o}})}subscribeToAutomations(e,t,r){console.log("=== SUBSCRIBETOAUTOMATIONS ==="),console.log(`userId: ${e}, boardId: ${t}`);let o=`users/${e}/boards/${t}/automations`;console.log("Tentando subscri\xE7\xE3o no caminho prim\xE1rio:",o);let a=d(this.firestore,o);return g(a,n=>{let u=n.docs.map(h=>i({id:h.id},h.data()));console.log(`Automa\xE7\xF5es encontradas via subscri\xE7\xE3o (${o}):`,u),u.length>0?r(u):(console.log("Nenhuma automa\xE7\xE3o encontrada no caminho prim\xE1rio, tentando alternativo..."),this.tryAlternativeAutomationPaths(e,t,r))},n=>{console.error("Erro na subscri\xE7\xE3o prim\xE1ria:",n),console.log("Tentando caminho alternativo devido ao erro..."),this.tryAlternativeAutomationPaths(e,t,r)})}tryAlternativeAutomationPaths(e,t,r){let o=`boards/${t}/automations`;console.log("Tentando caminho alternativo:",o);let a=d(this.firestore,o);return g(a,s=>{let n=s.docs.map(u=>i({id:u.id},u.data()));console.log(`Automa\xE7\xF5es encontradas via caminho alternativo (${o}):`,n),n.length>0?r(n):(console.log("Tentando collectionGroup..."),this.tryCollectionGroupAutomations(t,r))},s=>{console.error("Erro no caminho alternativo:",s),console.log("Tentando collectionGroup devido ao erro..."),this.tryCollectionGroupAutomations(t,r)})}tryCollectionGroupAutomations(e,t){let r=x(this.firestore,"automations");return g(r,o=>{let s=o.docs.map(n=>i({id:n.id,path:n.ref.path},n.data())).filter(n=>n.path.split("/").includes(e));console.log(`Automa\xE7\xF5es encontradas via collectionGroup: ${s.length} itens`),t(s)},o=>{console.error("Erro no collectionGroup:",o),t([])})}static \u0275fac=function(t){return new(t||R)};static \u0275prov=z({token:R,factory:R.\u0275fac,providedIn:"root"})};export{G as a};
