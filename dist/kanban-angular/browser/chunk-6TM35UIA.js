import{b as D}from"./chunk-KJIKDUO6.js";import{a as _}from"./chunk-4Y7IPZDV.js";import{B as z,D as H,a as O,b as A,c as p,e as R,f as U,n as q,o as V,r as j,s as G}from"./chunk-CXGKOLI5.js";import{$ as B}from"./chunk-3VCHQSRR.js";import{Ab as o,Bb as l,Bc as $,Ib as C,Ic as F,J as P,Jb as b,Sb as y,Ta as m,Tb as n,Vb as v,Wb as L,_ as k,a as E,b as w,bb as I,da as f,f as T,gb as x,ta as g,w as u,yb as c,z as N,zb as i}from"./chunk-CM3JQ4U2.js";var M=class s{http=f(D);subdomainService=f(_);sendEmail(e){let t=this.subdomainService.getCurrentCompany();if(!t)return u(()=>new Error("Contexto da empresa n\xE3o inicializado"));if(!this.validateSmtpConfig(t))return u(()=>new Error("Configura\xE7\xE3o SMTP da empresa est\xE1 incompleta"));let r=w(E({},e),{smtpConfig:{host:t.smtpConfig.host,port:t.smtpConfig.port,secure:t.smtpConfig.secure,auth:{user:t.smtpConfig.user,pass:t.smtpConfig.password}},from:{name:t.smtpConfig.fromName,email:t.smtpConfig.fromEmail},companyId:t.id}),a=this.getEmailApiUrl();return this.http.post(a,r).pipe(N(d=>w(E({},d),{success:!0,messageId:d.messageId})),P(d=>(console.error("Erro ao enviar email:",d),u(()=>({success:!1,error:d.error?.message||"Erro desconhecido ao enviar email"})))))}sendTemplateEmail(e,t,r,a){return this.sendEmail({to:t,subject:a||"Email autom\xE1tico",templateId:e,templateData:r})}sendNotificationEmail(e,t,r,a=!1){let d={to:e,subject:t,[a?"html":"text"]:r};return this.sendEmail(d)}sendNewLeadNotification(e,t,r){let a=this.subdomainService.getCurrentCompany();if(!a)return u(()=>new Error("Empresa n\xE3o encontrada"));let d=`Novo Lead: ${e.fields.contactName||e.fields.companyName||"Lead sem nome"}`,S=`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background-color: ${a.primaryColor||"#007bff"}; color: white; padding: 20px; text-align: center;">
          <h1>${a.name}</h1>
          <h2>Novo Lead Recebido</h2>
        </div>
        
        <div style="padding: 20px; background-color: #f8f9fa;">
          <h3>Detalhes do Lead:</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Quadro:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${t}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Fase:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${r}</td>
            </tr>
            ${e.fields.companyName?`
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Empresa:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${e.fields.companyName}</td>
            </tr>
            `:""}
            ${e.fields.contactName?`
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Contato:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${e.fields.contactName}</td>
            </tr>
            `:""}
            ${e.fields.contactEmail?`
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Email:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${e.fields.contactEmail}</td>
            </tr>
            `:""}
            ${e.fields.contactPhone?`
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Telefone:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${e.fields.contactPhone}</td>
            </tr>
            `:""}
          </table>
        </div>
        
        <div style="padding: 20px; text-align: center; color: #666;">
          <p>
            <a href="${this.subdomainService.getCompanyUrl(a.subdomain)}" 
               style="background-color: ${a.primaryColor||"#007bff"}; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; display: inline-block;">
              Ver no Sistema
            </a>
          </p>
        </div>
      </div>
    `;return this.sendEmail({to:a.ownerEmail,subject:d,html:S})}testSmtpConfiguration(){let e=this.subdomainService.getCurrentCompany();if(!e)return u(()=>new Error("Empresa n\xE3o encontrada"));let t={to:e.ownerEmail,subject:`Teste SMTP - ${e.name}`,html:`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <h2 style="color: ${e.primaryColor||"#007bff"};">Teste de Configura\xE7\xE3o SMTP</h2>
          <p>Este \xE9 um email de teste para verificar se a configura\xE7\xE3o SMTP est\xE1 funcionando corretamente.</p>
          <p><strong>Empresa:</strong> ${e.name}</p>
          <p><strong>Subdom\xEDnio:</strong> ${e.subdomain}</p>
          <p><strong>Servidor SMTP:</strong> ${e.smtpConfig.host}:${e.smtpConfig.port}</p>
          <p><strong>Data/Hora:</strong> ${new Date().toLocaleString("pt-BR")}</p>
          <p style="color: #28a745; font-weight: bold;">\u2705 Configura\xE7\xE3o SMTP funcionando corretamente!</p>
        </div>
      `};return this.sendEmail(t)}validateSmtpConfig(e){let t=e.smtpConfig;return!!(t&&t.host&&t.port&&t.user&&t.password&&t.fromName&&t.fromEmail)}getEmailApiUrl(){return`${this.subdomainService.getApiUrl()}/emails/send`}getCurrentEmailConfig(){let e=this.subdomainService.getCurrentCompany();return e?{fromName:e.smtpConfig.fromName,fromEmail:e.smtpConfig.fromEmail,isConfigured:this.validateSmtpConfig(e),host:e.smtpConfig.host,port:e.smtpConfig.port,secure:e.smtpConfig.secure}:null}updateSmtpConfig(e){let t=this.subdomainService.getCurrentCompany();if(!t)return u(()=>new Error("Empresa n\xE3o encontrada"));let r=`${this.subdomainService.getApiUrl()}/smtp-config`;return this.http.put(r,e).pipe(N(a=>(t&&(t.smtpConfig=E({},e),this.subdomainService.setCurrentCompany(t)),a)),P(a=>(console.error("Erro ao atualizar configura\xE7\xE3o SMTP:",a),u(()=>a))))}static \u0275fac=function(t){return new(t||s)};static \u0275prov=k({token:s,factory:s.\u0275fac,providedIn:"root"})};function K(s,e){s&1&&(i(0,"span"),n(1," (SSL/TLS)"),o())}function W(s,e){if(s&1&&(i(0,"div",39),n(1),x(2,K,2,0,"span",40),o()),s&2){let t,r,a=b(2);m(),L(" Servidor: ",(t=a.configStatus())==null?null:t.host,":",(t=a.configStatus())==null?null:t.port," "),m(),c("ngIf",(r=a.configStatus())==null?null:r.secure)}}function X(s,e){if(s&1&&(i(0,"div",34)(1,"div",5)(2,"div",37)(3,"div"),l(4,"i"),o(),i(5,"div")(6,"strong"),n(7,"Status: "),o(),i(8,"span"),n(9),o(),x(10,W,3,3,"div",38),o()()()()),s&2){let t,r,a,d,S,h=b();m(3),y((t=h.configStatus())!=null&&t.isConfigured?"text-success":"text-warning"),m(),y((r=h.configStatus())!=null&&r.isConfigured?"fas fa-check-circle":"fas fa-exclamation-triangle"),m(4),y((a=h.configStatus())!=null&&a.isConfigured?"text-success":"text-warning"),m(),v(" ",(d=h.configStatus())!=null&&d.isConfigured?"Configurado":"N\xE3o Configurado"," "),m(),c("ngIf",(S=h.configStatus())==null?null:S.isConfigured)}}function Y(s,e){if(s&1&&(i(0,"div",41),l(1,"i",42),n(2),o()),s&2){let t=b();m(2),v(" ",t.successMessage()," ")}}function Z(s,e){if(s&1&&(i(0,"div",43),l(1,"i",44),n(2),o()),s&2){let t=b();m(2),v(" ",t.errorMessage()," ")}}var Q=class s{fb=f(z);smtpService=f(M);subdomainService=f(_);companyService=f(B);smtpForm;isLoading=g(!1);successMessage=g(null);errorMessage=g(null);currentCompany=g(null);configStatus=g(null);constructor(){this.smtpForm=this.fb.group({host:["",p.required],port:[587,[p.required,p.min(1),p.max(65535)]],secure:[!1],user:["",[p.required,p.email]],password:["",p.required],fromName:["",p.required],fromEmail:["",[p.required,p.email]]})}ngOnInit(){this.currentCompany.set(this.subdomainService.getCurrentCompany()),this.loadCurrentConfiguration(),this.updateConfigStatus()}loadCurrentConfiguration(){let e=this.currentCompany();e&&e.smtpConfig?this.smtpForm.patchValue({host:e.smtpConfig.host,port:e.smtpConfig.port,secure:e.smtpConfig.secure,user:e.smtpConfig.user,password:e.smtpConfig.password,fromName:e.smtpConfig.fromName,fromEmail:e.smtpConfig.fromEmail}):e&&this.smtpForm.patchValue({fromName:e.name,fromEmail:e.contactEmail||e.ownerEmail})}saveConfiguration(){return T(this,null,function*(){if(this.smtpForm.invalid){this.showError("Por favor, preencha todos os campos obrigat\xF3rios.");return}this.isLoading.set(!0),this.clearMessages();try{let e=this.smtpForm.value,t=this.currentCompany();t&&(yield this.companyService.updateCompany(t.id,{smtpConfig:{host:e.host,port:e.port,secure:e.secure,user:e.user,password:e.password,fromName:e.fromName,fromEmail:e.fromEmail}}),t.smtpConfig=e,this.currentCompany.set(t),this.subdomainService.setCurrentCompany(t),this.updateConfigStatus(),this.showSuccess("Configura\xE7\xE3o SMTP salva com sucesso!"))}catch(e){console.error("Erro ao salvar configura\xE7\xE3o SMTP:",e),this.showError("Erro ao salvar configura\xE7\xE3o SMTP. Tente novamente.")}finally{this.isLoading.set(!1)}})}testConfiguration(){if(this.smtpForm.invalid){this.showError("Por favor, preencha todos os campos obrigat\xF3rios.");return}this.isLoading.set(!0),this.clearMessages(),this.smtpService.testSmtpConfiguration().subscribe({next:e=>{e.success?this.showSuccess("Email de teste enviado com sucesso! Verifique sua caixa de entrada."):this.showError("Falha ao enviar email de teste: "+(e.error||"Erro desconhecido")),this.isLoading.set(!1)},error:e=>{console.error("Erro ao testar configura\xE7\xE3o SMTP:",e),this.showError("Erro ao testar configura\xE7\xE3o SMTP: "+(e.message||"Erro desconhecido")),this.isLoading.set(!1)}})}loadPreset(e){let r={gmail:{host:"smtp.gmail.com",port:587,secure:!1},outlook:{host:"smtp-mail.outlook.com",port:587,secure:!1}}[e];this.smtpForm.patchValue(r)}updateConfigStatus(){let e=this.smtpService.getCurrentEmailConfig();this.configStatus.set(e)}showSuccess(e){this.successMessage.set(e),this.errorMessage.set(null),setTimeout(()=>this.successMessage.set(null),5e3)}showError(e){this.errorMessage.set(e),this.successMessage.set(null),setTimeout(()=>this.errorMessage.set(null),5e3)}clearMessages(){this.successMessage.set(null),this.errorMessage.set(null)}static \u0275fac=function(t){return new(t||s)};static \u0275cmp=I({type:s,selectors:[["app-smtp-config"]],decls:109,vars:9,consts:[[1,"smtp-config-container"],[1,"card"],[1,"card-header"],[1,"fas","fa-envelope"],[1,"text-muted"],[1,"card-body"],[3,"ngSubmit","formGroup"],[1,"row"],[1,"col-md-8"],[1,"mb-3"],[1,"form-label"],["type","text","formControlName","host","placeholder","smtp.gmail.com",1,"form-control"],[1,"form-text"],[1,"col-md-4"],["type","number","formControlName","port","placeholder","587",1,"form-control"],[1,"col-md-6"],["type","email","formControlName","user","placeholder","seu-email@gmail.com",1,"form-control"],["type","password","formControlName","password","placeholder","sua-senha-ou-app-password",1,"form-control"],["type","text","formControlName","fromName",1,"form-control",3,"placeholder"],["type","email","formControlName","fromEmail","placeholder","noreply@suaempresa.com",1,"form-control"],[1,"form-check"],["type","checkbox","formControlName","secure","id","secureConnection",1,"form-check-input"],["for","secureConnection",1,"form-check-label"],[1,"d-flex","gap-2","flex-wrap"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"fas","fa-save"],["type","button",1,"btn","btn-outline-info",3,"click","disabled"],[1,"fas","fa-paper-plane"],["type","button",1,"btn","btn-outline-secondary",3,"click"],[1,"fab","fa-google"],[1,"fab","fa-microsoft"],["class","card mt-3",4,"ngIf"],["class","alert alert-success mt-3",4,"ngIf"],["class","alert alert-danger mt-3",4,"ngIf"],[1,"card","mt-3"],[1,"fas","fa-info-circle"],[1,"small"],[1,"d-flex","align-items-center","gap-3"],["class","text-muted small",4,"ngIf"],[1,"text-muted","small"],[4,"ngIf"],[1,"alert","alert-success","mt-3"],[1,"fas","fa-check-circle"],[1,"alert","alert-danger","mt-3"],[1,"fas","fa-exclamation-circle"]],template:function(t,r){if(t&1&&(i(0,"div",0)(1,"div",1)(2,"div",2)(3,"h3"),l(4,"i",3),n(5," Configura\xE7\xE3o SMTP"),o(),i(6,"p",4),n(7,"Configure o servidor de email para sua empresa"),o()(),i(8,"div",5)(9,"form",6),C("ngSubmit",function(){return r.saveConfiguration()}),i(10,"div",7)(11,"div",8)(12,"div",9)(13,"label",10),n(14,"Servidor SMTP *"),o(),l(15,"input",11),i(16,"div",12),n(17,"Endere\xE7o do servidor SMTP"),o()()(),i(18,"div",13)(19,"div",9)(20,"label",10),n(21,"Porta *"),o(),l(22,"input",14),i(23,"div",12),n(24,"Porta do servidor SMTP"),o()()()(),i(25,"div",7)(26,"div",15)(27,"div",9)(28,"label",10),n(29,"Usu\xE1rio/Email *"),o(),l(30,"input",16),i(31,"div",12),n(32,"Email para autentica\xE7\xE3o"),o()()(),i(33,"div",15)(34,"div",9)(35,"label",10),n(36,"Senha *"),o(),l(37,"input",17),i(38,"div",12),n(39,"Senha ou App Password"),o()()()(),i(40,"div",7)(41,"div",15)(42,"div",9)(43,"label",10),n(44,"Nome do Remetente *"),o(),l(45,"input",18),i(46,"div",12),n(47,"Nome que aparecer\xE1 nos emails"),o()()(),i(48,"div",15)(49,"div",9)(50,"label",10),n(51,"Email do Remetente *"),o(),l(52,"input",19),i(53,"div",12),n(54,"Email que aparecer\xE1 como remetente"),o()()()(),i(55,"div",9)(56,"div",20),l(57,"input",21),i(58,"label",22),n(59," Conex\xE3o segura (SSL/TLS) "),o(),i(60,"div",12),n(61,"Recomendado para a maioria dos provedores"),o()()(),i(62,"div",23)(63,"button",24),l(64,"i",25),n(65),o(),i(66,"button",26),C("click",function(){return r.testConfiguration()}),l(67,"i",27),n(68),o(),i(69,"button",28),C("click",function(){return r.loadPreset("gmail")}),l(70,"i",29),n(71," Gmail "),o(),i(72,"button",28),C("click",function(){return r.loadPreset("outlook")}),l(73,"i",30),n(74," Outlook "),o()()()()(),x(75,X,11,8,"div",31)(76,Y,3,1,"div",32)(77,Z,3,1,"div",33),i(78,"div",34)(79,"div",2)(80,"h6"),l(81,"i",35),n(82," Dicas de Configura\xE7\xE3o"),o()(),i(83,"div",5)(84,"div",7)(85,"div",15)(86,"h6"),n(87,"Gmail:"),o(),i(88,"ul",36)(89,"li"),n(90,"Servidor: smtp.gmail.com"),o(),i(91,"li"),n(92,"Porta: 587 (TLS) ou 465 (SSL)"),o(),i(93,"li"),n(94,"Use App Password, n\xE3o sua senha normal"),o(),i(95,"li"),n(96,"Ative autentica\xE7\xE3o de 2 fatores"),o()()(),i(97,"div",15)(98,"h6"),n(99,"Outlook/Hotmail:"),o(),i(100,"ul",36)(101,"li"),n(102,"Servidor: smtp-mail.outlook.com"),o(),i(103,"li"),n(104,"Porta: 587 (TLS)"),o(),i(105,"li"),n(106,"Use sua senha normal"),o(),i(107,"li"),n(108,"Certifique-se que SMTP est\xE1 habilitado"),o()()()()()()()),t&2){let a;m(9),c("formGroup",r.smtpForm),m(36),c("placeholder",((a=r.currentCompany())==null?null:a.name)||"Nome da Empresa"),m(18),c("disabled",r.smtpForm.invalid||r.isLoading()),m(2),v(" ",r.isLoading()?"Salvando...":"Salvar Configura\xE7\xE3o"," "),m(),c("disabled",r.smtpForm.invalid||r.isLoading()),m(2),v(" ",r.isLoading()?"Enviando...":"Enviar Email de Teste"," "),m(7),c("ngIf",r.configStatus()),m(),c("ngIf",r.successMessage()),m(),c("ngIf",r.errorMessage())}},dependencies:[F,$,H,q,A,V,O,R,U,j,G],styles:[".smtp-config-container[_ngcontent-%COMP%]{max-width:800px;margin:0 auto;padding:20px}.card-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#495057}.form-control[_ngcontent-%COMP%]:focus{border-color:#80bdff;box-shadow:0 0 0 .2rem #007bff40}.btn[_ngcontent-%COMP%]{border-radius:6px}.btn-primary[_ngcontent-%COMP%]{background-color:#007bff;border-color:#007bff}.alert[_ngcontent-%COMP%]{border-radius:6px}.form-text[_ngcontent-%COMP%]{font-size:.875rem}"]})};export{Q as SmtpConfigComponent};
