import{a as fe}from"./chunk-W3OFA55M.js";import{A as le,C as se,I as me,K as ce,c as J,h as W,i as X,l as Y,m as ee,t as te,u as ie,v as oe,x as ne,y as re,z as ae}from"./chunk-QT4WKFE7.js";import"./chunk-ZBJHR7UR.js";import{F as pe,H as de,I as ue}from"./chunk-77VQYYTZ.js";import{Eb as o,Fb as s,Gb as m,Hb as _,Lb as T,Mb as $,Nc as z,Ob as V,Oc as K,Pb as k,Pc as H,Qc as q,Rb as p,Rc as Q,Va as D,Vc as Z,Xb as j,Ya as r,Yb as G,a as I,ac as f,b as O,bc as v,cc as R,f as E,fa as x,gb as M,la as A,lb as b,ma as U,mc as N,uc as B,wa as S,wb as P}from"./chunk-HM7IHYI7.js";var L=()=>[],be=()=>["Quente","Morno","Frio"];function ye(t,i){if(t&1&&(s(0,"div",12),_(1,"img",13),m()),t&2){let e=p();r(),o("src",e.companyLogo,D)}}function _e(t,i){if(t&1&&(s(0,"span",14),f(1),m()),t&2){let e=p();r(),v(e.companyName())}}function he(t,i){t&1&&(s(0,"div",15),f(1,"Carregando..."),m())}function ve(t,i){t&1&&(s(0,"div",15),f(1,"Nenhum campo configurado para esta fase."),m())}function Ce(t,i){if(t&1&&_(0,"input",31),t&2){let e=p().$implicit;o("formControlName",e.name)}}function xe(t,i){if(t&1&&_(0,"input",32),t&2){let e=p().$implicit;o("formControlName",e.name)}}function Fe(t,i){if(t&1&&_(0,"input",33),t&2){let e=p().$implicit;o("formControlName",e.name)}}function Se(t,i){if(t&1&&_(0,"input",34),t&2){let e=p().$implicit;o("formControlName",e.name)}}function Ne(t,i){if(t&1&&_(0,"textarea",35),t&2){let e=p().$implicit;o("formControlName",e.name)}}function Ie(t,i){if(t&1&&(s(0,"option",40),f(1),m()),t&2){let e=i.$implicit;o("value",e.value),r(),v(e.label)}}function we(t,i){if(t&1&&(T(0),b(1,Ie,2,2,"option",39),$()),t&2){let e=p(2).$implicit;r(),o("ngForOf",e.options)}}function Ee(t,i){if(t&1&&(s(0,"option",40),f(1),m()),t&2){let e=i.$implicit;o("value",e),r(),v(e)}}function Pe(t,i){if(t&1&&b(0,Ee,2,2,"option",39),t&2){let e=p(2).$implicit;o("ngForOf",e.options||N(1,L))}}function Te(t,i){if(t&1&&(s(0,"select",36)(1,"option",37),f(2,"Selecione..."),m(),b(3,we,2,1,"ng-container",38)(4,Pe,1,2,"ng-template",null,0,B),m()),t&2){let e=j(5),n=p().$implicit;o("formControlName",n.name),r(3),o("ngIf",n.options&&n.options.length&&typeof n.options[0]=="object")("ngIfElse",e)}}function $e(t,i){if(t&1&&(s(0,"label",43),_(1,"input",44),s(2,"span"),f(3),m()()),t&2){let e=i.$implicit,n=p(2).$implicit;r(),o("value",(e==null?null:e.value)??e)("formControlName",n.name),P("name",n.name),r(2),v((e==null?null:e.label)??e)}}function Le(t,i){if(t&1&&(s(0,"div",41),b(1,$e,4,4,"label",42),m()),t&2){let e=p().$implicit;r(),o("ngForOf",e.options||N(1,L))}}function Oe(t,i){if(t&1&&(s(0,"label",43),_(1,"input",45),s(2,"span"),f(3),m()()),t&2){let e=i.$implicit,n=i.index,a=p(2).$implicit;r(),o("value",e)("formControlName",a.name+"_"+n),P("name",a.name+"_"+n),r(2),v(e)}}function Ae(t,i){if(t&1&&(s(0,"div",41),b(1,Oe,4,4,"label",42),m()),t&2){let e=p().$implicit;r(),o("ngForOf",e.options||N(1,L))}}function Ue(t,i){if(t&1&&(s(0,"option",40),f(1),m()),t&2){let e=i.$implicit;o("value",e),r(),v(e)}}function De(t,i){if(t&1&&(s(0,"select",36)(1,"option",37),f(2,"Selecione..."),m(),b(3,Ue,2,2,"option",39),m()),t&2){let e=p().$implicit;o("formControlName",e.name),r(3),o("ngForOf",e.options&&e.options.length?e.options:N(2,be))}}function Me(t,i){if(t&1&&_(0,"input",31),t&2){let e=p().$implicit;o("formControlName",e.name)}}function Ve(t,i){if(t&1&&(s(0,"div",20)(1,"label",21),f(2),m(),T(3,22),b(4,Ce,1,1,"input",23)(5,xe,1,1,"input",24)(6,Fe,1,1,"input",25)(7,Se,1,1,"input",26)(8,Ne,1,1,"textarea",27)(9,Te,6,3,"select",28)(10,Le,2,2,"div",29)(11,Ae,2,2,"div",29)(12,De,4,3,"select",28)(13,Me,1,1,"input",30),$(),m()),t&2){let e=i.$implicit;r(2),v(e.label),r(),o("ngSwitch",e.type),r(),o("ngSwitchCase","text"),r(),o("ngSwitchCase","email"),r(),o("ngSwitchCase","tel"),r(),o("ngSwitchCase","number"),r(),o("ngSwitchCase","textarea"),r(),o("ngSwitchCase","select"),r(),o("ngSwitchCase","radio"),r(),o("ngSwitchCase","checkbox"),r(),o("ngSwitchCase","temperatura")}}function ke(t,i){if(t&1){let e=V();s(0,"form",16),k("ngSubmit",function(){A(e);let a=p();return U(a.onSubmit())}),b(1,Ve,14,11,"div",17),s(2,"div",18)(3,"button",19),f(4),m()()()}if(t&2){let e=p();o("formGroup",e.form),r(),o("ngForOf",e.currentFields),r(2),G("background-color",e.primaryColor()),o("disabled",e.saving()),r(),R(" ",e.saving()?"Salvando...":"Salvar"," ")}}var ge=class t{route=x(J);fs=x(de);subdomain=x(pe);toast=x(fe);fb=x(me);companyService=x(ue);form=this.fb.group({});loading=S(!0);saving=S(!1);fieldsLoaded=S(!1);companyName=S(null);primaryColor=S(this.subdomain.getCurrentCompany()?.brandingConfig?.primaryColor||"#3B82F6");companyLogo=null;userId="";boardId="";columnId="";leadId="";currentFields=[];lead=null;companyUsers=[];ngOnInit(){return E(this,null,function*(){let i=this.route.snapshot.queryParamMap,e=i.get("subdomain")||void 0,n=i.get("companyId")||"";this.userId=i.get("userId")||"",this.boardId=i.get("boardId")||"",this.leadId=i.get("leadId")||"",this.columnId=i.get("columnId")||"";try{let a=null;if(n&&(a=yield this.companyService.getCompany(n)),!a&&e&&(a=yield this.companyService.getCompanyBySubdomain(e)),a||(a=yield this.subdomain.initializeFromSubdomain()),a){this.subdomain.setCurrentCompany(a),this.companyName.set(a.name||e||null),this.primaryColor.set(a.brandingConfig?.primaryColor||"#3B82F6");let d=a.subdomain;this.companyLogo=(a.brandingConfig?.logo&&a.brandingConfig.logo.trim()!==""?a.brandingConfig.logo:null)||(d==="gobuyer"?"https://apps.gobuyer.com.br/sso/assets/images/logos/logo-gobuyer.png":null)}else e&&this.companyName.set(e)}catch{this.companyName.set(e||null)}try{this.leadId&&(this.lead=yield this.fs.getLead(this.userId,this.boardId,this.leadId))}catch{}try{let d=(yield this.fs.getPhaseFormConfig(this.userId,this.boardId,this.columnId))?.fields||[];if(this.currentFields=d.sort((l,h)=>(l.order||0)-(h.order||0)),this.currentFields.some(l=>l.type==="responsavel")){let l=this.subdomain.getCurrentCompany();if(l?.id)try{let h=yield this.companyService.getAllCompanyUsers(l.id);this.companyUsers=h||[],this.currentFields=this.currentFields.map(u=>u.type==="responsavel"?O(I({},u),{type:"select",originalType:"responsavel",options:h.map(c=>({value:c.uid||c.email,label:c.displayName||c.email}))}):u)}catch{}}let g={};this.currentFields.forEach(l=>{let h=l.apiFieldName||l.name,u=this.lead?.fields?.[h]??"";l.type==="checkbox"?(l.options||[]).forEach((c,F)=>{let w=l.name+"_"+F,C=Array.isArray(u)?u.includes(c):!1;g[w]=[C]}):g[l.name]=[u],l.type==="radio"&&Array.isArray(l.options)&&(l.options=l.options.map(c=>typeof c=="object"?c:{value:c,label:c}))}),this.form=this.fb.group(g),this.fieldsLoaded.set(this.currentFields.length>0)}catch{this.currentFields=[],this.fieldsLoaded.set(!1)}this.loading.set(!1)})}mapFormToLeadFields(){let i=this.form.value,e={};return this.currentFields.forEach(n=>{let a=n.apiFieldName||n.name;if(n.type==="checkbox"){let d=[];(n.options||[]).forEach((y,g)=>{let l=n.name+"_"+g;i[l]&&d.push(y)}),e[a]=d}else e[a]=i[n.name]}),e}onSubmit(){return E(this,null,function*(){if(!(!this.lead||!this.leadId)){this.saving.set(!0);try{let i=this.mapFormToLeadFields(),e={fields:I(I({},this.lead.fields||{}),i)};try{let n=this.currentFields.find(a=>a.originalType==="responsavel"||a.type==="responsavel"||(a.name||"").toLowerCase()==="responsavel");if(n){let a=n.name,d=this.form.get(a)?.value;if(d&&d!==this.lead.responsibleUserId){let y=this.companyUsers.find(l=>l.uid&&l.uid===d||l.email&&l.email===d);e.responsibleUserId=y?.uid||d,e.responsibleUserName=y?.displayName||"",e.responsibleUserEmail=y?.email||"",console.log("Respons\xE1vel alterado via formul\xE1rio p\xFAblico:",y?.displayName);let g=this.subdomain.getCurrentCompany();g&&this.fs.setCompanyContext(g),yield this.fs.addLeadHistory(this.userId,this.boardId,this.leadId,{type:"update",text:`Respons\xE1vel alterado para <strong>${y?.displayName||"Ningu\xE9m"}</strong> via formul\xE1rio p\xFAblico`,user:"Formul\xE1rio P\xFAblico"})}}}catch{}try{let n=this.lead.fields||{},a=Object.keys(i).filter(d=>`${n[d]??""}`!=`${i[d]??""}`);if(console.log("Debug formul\xE1rio p\xFAblico:",{beforeFields:n,mapped:i,changedKeys:a,hasChanges:a.length>0}),a.length){let d=a.map(g=>{let l=this.currentFields.find(F=>(F.apiFieldName||F.name)===g),h=l?.label||this.humanizeKey(g),u=n[g]??"",c=i[g]??"";if(l&&(l.type==="responsavel"||l.originalType==="responsavel")){let F=this.companyUsers.find(C=>C.uid===u||C.email===u),w=this.companyUsers.find(C=>C.uid===c||C.email===c);u=F?.displayName||u,c=w?.displayName||c}return Array.isArray(c)&&(c=c.join(", ")),Array.isArray(u)&&(u=u.join(", ")),`<li><strong>${h}:</strong> "${u}" \u2192 "${c}"</li>`}).join("");console.log("Adicionando ao hist\xF3rico:",{userId:this.userId,boardId:this.boardId,leadId:this.leadId,changesList:d});let y=this.subdomain.getCurrentCompany();y&&this.fs.setCompanyContext(y),yield this.fs.addLeadHistory(this.userId,this.boardId,this.leadId,{type:"update",text:`Formul\xE1rio p\xFAblico preenchido:<ul class="list-disc ml-4">${d}</ul>`,user:"Formul\xE1rio P\xFAblico"}),console.log("Hist\xF3rico adicionado com sucesso")}}catch(n){console.warn("Erro ao registrar hist\xF3rico:",n)}yield this.fs.updateLead(this.userId,this.boardId,this.leadId,e);try{this.toast.success("Formul\xE1rio salvo.")}catch{}}catch(i){console.error(i);try{this.toast.error("Erro ao salvar formul\xE1rio.")}catch{}}finally{this.saving.set(!1)}}})}humanizeKey(i){return i.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()).trim()}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=M({type:t,selectors:[["app-public-form"]],decls:16,vars:5,consts:[["simpleOpts",""],[1,"min-h-screen","bg-gray-50","py-10","px-4"],[1,"max-w-2xl","mx-auto"],["class","mb-6 text-center",4,"ngIf"],[1,"bg-white","border","border-gray-200","rounded-xl","shadow-sm"],[1,"px-6","py-4","border-b","border-gray-200","flex","items-center","justify-between"],[1,"text-lg","font-semibold","text-gray-900"],["class","text-xs text-gray-500",4,"ngIf"],[1,"p-6"],["class","text-sm text-gray-500",4,"ngIf"],["class","space-y-4",3,"formGroup","ngSubmit",4,"ngIf"],[1,"mt-6","text-center","text-xs","text-gray-400"],[1,"mb-6","text-center"],["alt","Logo da empresa",1,"h-10","inline-block",3,"src"],[1,"text-xs","text-gray-500"],[1,"text-sm","text-gray-500"],[1,"space-y-4",3,"ngSubmit","formGroup"],["class","space-y-1",4,"ngFor","ngForOf"],[1,"pt-2"],["type","submit",1,"px-4","py-2","text-white","rounded-lg",3,"disabled"],[1,"space-y-1"],[1,"block","text-sm","font-medium","text-gray-700"],[3,"ngSwitch"],["type","text","class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchCase"],["type","email","class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchCase"],["type","tel","class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchCase"],["type","number","class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchCase"],["rows","3","class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchCase"],["class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchCase"],["class","flex flex-col gap-2",4,"ngSwitchCase"],["type","text","class","w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",3,"formControlName",4,"ngSwitchDefault"],["type","text",1,"w-full","p-3","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500",3,"formControlName"],["type","email",1,"w-full","p-3","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500",3,"formControlName"],["type","tel",1,"w-full","p-3","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500",3,"formControlName"],["type","number",1,"w-full","p-3","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500",3,"formControlName"],["rows","3",1,"w-full","p-3","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500",3,"formControlName"],[1,"w-full","p-3","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500",3,"formControlName"],["value",""],[4,"ngIf","ngIfElse"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"flex","flex-col","gap-2"],["class","inline-flex items-center gap-2 text-sm text-gray-700",4,"ngFor","ngForOf"],[1,"inline-flex","items-center","gap-2","text-sm","text-gray-700"],["type","radio",1,"text-blue-600","focus:ring-blue-500",3,"value","formControlName"],["type","checkbox",1,"text-blue-600","focus:ring-blue-500",3,"value","formControlName"]],template:function(e,n){e&1&&(s(0,"div",1)(1,"div",2),b(2,ye,2,1,"div",3),s(3,"div",4)(4,"div",5)(5,"h1",6),f(6,"Formul\xE1rio"),m(),b(7,_e,2,1,"span",7),m(),s(8,"div",8),b(9,he,2,0,"div",9)(10,ve,2,0,"div",9)(11,ke,5,6,"form",10),m()(),s(12,"div",11),f(13," Powered by "),s(14,"strong"),f(15,"Task Board"),m()()()()),e&2&&(r(2),o("ngIf",n.companyLogo),r(5),o("ngIf",n.companyName()),r(2),o("ngIf",n.loading()),r(),o("ngIf",!n.loading()&&!n.fieldsLoaded()),r(),o("ngIf",n.fieldsLoaded()))},dependencies:[Z,z,K,H,q,Q,ce,te,le,se,X,ie,W,ae,oe,Y,ee,ne,re],encapsulation:2})};export{ge as PublicFormComponent};
