<app-main-layout>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center items-center py-20">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
  </div>

  <!-- Tabs Navigation with Company Logo and Actions -->
  <nav *ngIf="!isLoading" class="bg-white px-4 md:px-8 border-b border-gray-200 sticky top-0 z-30">
    <div class="flex justify-between items-center">
      <!-- Left side: Back Button, Company Logo and Board Name -->
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-3">
          <!-- Back Button -->
          <button 
            (click)="goToDashboard()"
            class="text-gray-500 hover:text-gray-700 p-1 rounded hover:bg-gray-100 transition-colors">
            <i class="fas fa-arrow-left"></i>
          </button>
          
          <!-- Company Logo -->
          <div>
            @if (hasCompanyLogo()) {
              <img [src]="getCompanyLogo()" 
                   alt="Logo da Empresa" 
                   class="h-8 w-auto rounded">
            } @else {
              <div class="h-8 w-8 rounded-lg flex items-center justify-center text-white font-bold text-sm"
                   [style.background-color]="getPrimaryColor()">
                {{ getCompanyInitials() }}
              </div>
            }
          </div>
          
          <!-- Board Name oculto -->
          <div class="hidden">
            <h1 class="text-lg font-semibold text-gray-900">{{ board?.name }}</h1>
          </div>
        </div>
      </div>

      <!-- Center: Tab Navigation -->
      <div class="hidden md:flex space-x-8">
        <button
          *ngFor="let tab of tabs"
          (click)="switchTab(tab.id)"
          class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
          [class.border-blue-500]="activeTab === tab.id"
          [class.text-blue-600]="activeTab === tab.id"
          [class.border-transparent]="activeTab !== tab.id"
          [class.text-gray-500]="activeTab !== tab.id"
          [class.hover:text-gray-700]="activeTab !== tab.id">
          <i class="fas {{ tab.icon }} mr-2"></i>
          {{ tab.name }}
        </button>
      </div>

      <!-- Right side: Action Buttons -->
      <div class="hidden md:flex items-center space-x-2">
        <!-- Add any future action buttons here -->
      </div>
    </div>
  </nav>

  <!-- Desktop Filters Bar -->
  <div *ngIf="!isLoading && activeTab === 'kanban'" class="hidden md:block bg-white border-b border-gray-200 px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- Filtros básicos -->
      <div class="flex items-center gap-3">
        <div class="relative">
          <input
            type="text"
            placeholder="Buscar leads..."
            [(ngModel)]="filterQuery"
            (input)="applyFilters()"
            class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent w-64"
            [class.border-blue-200]="filterQuery"
            [class.bg-blue-50]="filterQuery">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
          <button 
            *ngIf="filterQuery"
            (click)="filterQuery = ''; applyFilters()"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 p-1">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>
        
        <button (click)="toggleOnlyMine()" 
                class="px-3 py-2 rounded-lg text-sm transition-colors border flex items-center gap-2"
                [class.bg-blue-50]="filterOnlyMine"
                [class.text-blue-700]="filterOnlyMine"
                [class.border-blue-200]="filterOnlyMine"
                [class.bg-gray-50]="!filterOnlyMine"
                [class.text-gray-600]="!filterOnlyMine"
                [class.border-gray-200]="!filterOnlyMine">
          <i class="fas fa-user" [class.fa-user-check]="filterOnlyMine"></i>
          Meus cards
        </button>
        
        
        <!-- Filtros avançados -->
        <button (click)="showAdvancedFilters = !showAdvancedFilters" 
                class="px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors border"
                [class.bg-purple-50]="getActiveDynamicFiltersCount() > 0"
                [class.text-purple-700]="getActiveDynamicFiltersCount() > 0"
                [class.border-purple-200]="getActiveDynamicFiltersCount() > 0"
                [class.bg-gray-50]="getActiveDynamicFiltersCount() === 0"
                [class.text-gray-600]="getActiveDynamicFiltersCount() === 0"
                [class.border-gray-200]="getActiveDynamicFiltersCount() === 0">
          <i class="fas fa-sliders-h"></i>
          <span>Filtros Avançados</span>
          <span *ngIf="getActiveDynamicFiltersCount() > 0" class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs">
            {{ getActiveDynamicFiltersCount() }}
          </span>
        </button>
      </div>
      
      <!-- Status e ações -->
      <div class="flex items-center gap-3">
        <div *ngIf="hasActiveFilters()" class="text-sm text-blue-600 flex items-center gap-2">
          <i class="fas fa-filter"></i>
          <span>{{ (filterQuery ? 1 : 0) + (filterOnlyMine ? 1 : 0) + getActiveDynamicFiltersCount() }} filtro(s) ativo(s)</span>
        </div>
        
        <button *ngIf="hasActiveFilters()" 
                (click)="clearFilters()" 
                class="px-3 py-2 bg-red-50 text-red-700 rounded-lg text-sm hover:bg-red-100 transition-colors flex items-center gap-2 border border-red-200">
          <i class="fas fa-times"></i>
          Limpar filtros
        </button>
      </div>
    </div>
    
    
    <!-- Painel de filtros avançados desktop -->
    <div *ngIf="showAdvancedFilters && availableFilterFields.length > 0" 
         class="mt-4 bg-gray-50 rounded-lg p-4 border">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <i class="fas fa-filter text-purple-600"></i>
          Filtros por Campos Dinâmicos
        </h4>
        <button (click)="showAdvancedFilters = false" 
                class="text-gray-400 hover:text-gray-600 p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div *ngFor="let field of availableFilterFields" 
             class="flex flex-col gap-2">
          <label class="text-sm font-medium text-gray-600">
            {{ field.label }}
            <span class="text-xs text-gray-400 ml-1">({{ field.type }})</span>
          </label>
          
          <!-- Campo de texto/email/tel -->
          <div *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'tel'" 
               class="flex items-center gap-2">
            <input type="text"
                   [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
                   [value]="getDynamicFilterValue(field.name)"
                   (input)="setDynamicFilter(field.name, $event.target.value)"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-2 text-red-400 hover:text-red-600 transition-colors">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
          
          <!-- Campo de número -->
          <div *ngIf="field.type === 'number'" 
               class="flex items-center gap-2">
            <input type="number"
                   [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
                   [value]="getDynamicFilterValue(field.name)"
                   (input)="setDynamicFilter(field.name, $event.target.value)"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-2 text-red-400 hover:text-red-600 transition-colors">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
          
          <!-- Campo de data -->
          <div *ngIf="field.type === 'date'" 
               class="flex items-center gap-2">
            <input type="date"
                   [value]="getDynamicFilterValue(field.name)"
                   (change)="setDynamicFilter(field.name, $event.target.value)"
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-2 text-red-400 hover:text-red-600 transition-colors">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
          
          <!-- Checkbox -->
          <label *ngIf="field.type === 'checkbox'" 
                 class="flex items-center gap-3">
            <input type="checkbox"
                   [checked]="getDynamicFilterValue(field.name)"
                   (change)="setDynamicFilter(field.name, $event.target.checked)"
                   class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
            <span class="text-sm text-gray-600">Apenas marcados</span>
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-1 text-red-400 hover:text-red-600 transition-colors ml-auto">
              <i class="fas fa-times text-xs"></i>
            </button>
          </label>
          
          <!-- Select/Radio/Temperatura -->
          <div *ngIf="field.type === 'select' || field.type === 'radio' || field.type === 'temperatura'" 
               class="flex items-center gap-2">
            <select [value]="getDynamicFilterValue(field.name)"
                    (change)="onDynamicFilterChange(field.name, $event)"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
              <option value="">Todos os valores</option>
              <option *ngFor="let option of getFieldOptions(field)" [value]="option">
                {{ option }}
              </option>
            </select>
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-2 text-red-400 hover:text-red-600 transition-colors">
              <i class="fas fa-times text-sm"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div *ngIf="getActiveDynamicFiltersCount() > 0" 
           class="mt-4 text-sm text-purple-600 flex items-center gap-2 pt-3 border-t">
        <i class="fas fa-info-circle"></i>
        <span>{{ getActiveDynamicFiltersCount() }} filtro(s) ativo(s) por campos</span>
      </div>
    </div>
  </div>

  <!-- Desktop Kanban Board Tab -->
  <div *ngIf="!isLoading && activeTab === 'kanban'" class="kanban-board desktop-board">
    <div 
      *ngFor="let column of columns" 
      class="kanban-column"
      [style.background-color]="'#e2e8f0'">
      
      <!-- Column Header -->
      <div 
        class="kanban-column-header"
        [style.border-top-color]="getColumnBorderColor(column)">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <h3 class="font-semibold text-gray-800">{{ column.name }}</h3>
            <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">
              {{ getLeadsForColumn(column.id!).length }}
            </span>
            <span *ngIf="getAutomationCount(column.id!) > 0" class="ml-2 inline-flex items-center text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800" title="Automações ativas nesta fase">
              <i class="fas fa-bolt mr-1"></i>{{ getAutomationCount(column.id!) }}
            </span>
          </div>
          
          
        </div>
      </div>

      <!-- Cards Container -->
      <div 
        class="kanban-cards"
        cdkDropList
        [id]="'column-' + column.id"
        [cdkDropListData]="displayedLeadsByColumn[column.id!] || []"
        [cdkDropListConnectedTo]="getColumnConnectedTo()"
        (cdkDropListDropped)="onLeadDrop($event)">
        
        <div 
          *ngFor="let lead of (displayedLeadsByColumn[column.id!] || []); trackBy: trackByLeadId" 
          class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200 cursor-pointer mb-3 p-4 border-l-4"
          [class]="getSlaStatus(lead).borderClass || getLeadPriorityClass(lead)"
          cdkDrag
          [cdkDragDisabled]="!cardMoveEnabled"
          [cdkDragData]="lead.id"
          (cdkDragStarted)="onLeadDragStarted()"
          (cdkDragEnded)="onLeadDragEnded()"
          (click)="onCardClick(lead, $event)">
          
          <!-- Card Header -->
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-gray-900 text-sm truncate mb-1">
                {{ getCompanyName(lead) }}
              </h4>
              <div *ngIf="getCnpj(lead)" class="text-xs text-gray-500">
                CNPJ: {{ getCnpj(lead) }}
              </div>
            </div>
            <!-- Removido badge fixa de temperatura (passará a exibir via showInCard como ícone) -->
          </div>

          <!-- Campos configurados para exibir no card -->
          <div class="space-y-2 mb-3">
            <div *ngFor="let item of getCardFieldsForLead(lead)" class="text-xs">
              <!-- Outros campos: exibir normal (temperatura vai para o rodapé) -->
              <div *ngIf="item.type !== 'temperatura'">
                <div class="font-medium text-gray-600 mb-0.5">{{ item.label }}</div>
                <div class="text-gray-900 truncate">{{ item.value }}</div>
              </div>
            </div>
          </div>

          <!-- SLA Status -->
          <div *ngIf="getSlaStatus(lead).text" class="mb-3">
            <div class="flex items-center text-xs font-medium"
                 [class]="getSlaStatus(lead).colorClass">
              <i class="fas fa-clock w-3 h-3 mr-1"></i>
              <span>{{ getSlaStatus(lead).text }}</span>
            </div>
          </div>

          <!-- Temperatura (sempre visível se existir) -->
          <div *ngIf="getTemperatureGlobalItem(lead) as temp" class="mb-3">
            <div class="flex items-center text-xs font-medium">
              <span [ngClass]="{
                'bg-red-500': temp.value === 'Quente',
                'bg-yellow-500': temp.value === 'Morno', 
                'bg-blue-500': temp.value === 'Frio'
              }" class="w-2 h-2 rounded-full mr-1"></span>
              <span>{{ temp.value }}</span>
            </div>
          </div>

          <!-- Card Footer -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 text-xs text-gray-500">
              <!-- Comentários count -->
              <div class="flex items-center" *ngIf="lead.historyCommentsCount as c"><i class="far fa-comment mr-1"></i><span>{{ c || 0 }}</span></div>
              <!-- Anexos count -->
              <div class="flex items-center" *ngIf="lead.attachmentsCount as a"><i class="fas fa-paperclip mr-1"></i><span>{{ a || 0 }}</span></div>
            </div>
            <div class="flex items-center text-xs text-gray-500">
              <i class="far fa-calendar-alt w-3 h-3 mr-1"></i>
              <span>{{ formatDateTime(lead.createdAt) }}</span>
            </div>
          </div>

          <!-- Description/Notes Preview -->
          <div *ngIf="lead.fields?.['description']" class="mt-2 pt-2 border-t border-gray-100">
            <p class="text-xs text-gray-600 line-clamp-2">
              {{ lead.fields['description'] }}
            </p>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="getLeadsForColumn(column.id!).length === 0" 
             class="text-center py-6 text-gray-400">
          <i class="fas fa-inbox text-2xl mb-2"></i>
          <p class="text-sm">Nenhum registro nesta fase</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Botão flutuante único: Novo registro -->
  <button 
    *ngIf="!isLoading && activeTab === 'kanban'"
    (click)="showCreateLeadModal()"
    class="fixed left-4 bottom-4 z-40 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2">
    <i class="fas fa-plus"></i>
    Novo registro
  </button>

  <!-- Initial Form Tab -->
  <div *ngIf="!isLoading && activeTab === 'initial-form'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Formulário inicial do quadro</h2>

      <app-visual-form-builder
        [fields]="initialFormFields"
        (fieldsChanged)="onInitialFieldsChanged($event)">
      </app-visual-form-builder>

      <div class="flex justify-end mt-6">
        <button class="px-4 py-2 text-white rounded-lg" [style.background-color]="getPrimaryColor()" (click)="saveInitialForm()">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- Configuração de formulário da fase removida daqui; usar ícone na própria coluna -->

  <!-- Empty State - No Columns -->
  <div *ngIf="!isLoading && activeTab === 'kanban' && columns.length === 0" class="text-center py-20">
    <div class="max-w-md mx-auto">
      <i class="fas fa-columns text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhuma coluna encontrada</h3>
      <p class="text-gray-600">
        Este quadro ainda não possui colunas configuradas.
      </p>
    </div>
  </div>

  <!-- Templates Tab -->
  <div *ngIf="!isLoading && activeTab === 'templates'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Templates de Email</h2>
        <button (click)="createTemplate()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          <i class="fas fa-plus mr-2"></i>
          Novo Template
        </button>
      </div>
      
      <!-- Lista de Templates -->
      <div *ngIf="emailTemplates.length > 0" class="grid gap-4">
        <div 
          *ngFor="let template of emailTemplates" 
          class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                {{ template.name || 'Template sem nome' }}
              </h3>
              <p class="text-sm text-gray-600 mb-3">
                <strong>Assunto:</strong> {{ template.subject || 'Sem assunto' }}
              </p>
              <p class="text-xs text-gray-500 mb-4">
                <strong>Para:</strong> {{ template.recipients || 'Não especificado' }}
              </p>
              <div class="flex items-center text-xs text-gray-500 space-x-4">
                <span>
                  <i class="far fa-calendar-alt mr-1"></i>
                  Criado em {{ formatDate(template.createdAt) }}
                </span>
                <span *ngIf="template.updatedAt">
                  <i class="fas fa-edit mr-1"></i>
                  Atualizado em {{ formatDate(template.updatedAt) }}
                </span>
              </div>
            </div>
            
            <div class="flex items-center space-x-2 ml-4">
              <button 
                (click)="editTemplate(template)"
                class="text-blue-600 hover:text-blue-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-edit mr-1"></i>
                Editar
              </button>
              <button 
                (click)="deleteTemplate(template)"
                class="text-red-600 hover:text-red-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-trash mr-1"></i>
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="emailTemplates.length === 0" class="bg-white rounded-lg shadow p-6">
        <div class="text-center py-12 text-gray-500">
          <i class="fas fa-envelope text-6xl mb-4"></i>
          <h3 class="text-xl font-semibold mb-2">Nenhum template encontrado</h3>
          <p>Crie templates personalizados para automações de email</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Automations Tab -->
  <div *ngIf="!isLoading && activeTab === 'automations'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Automações</h2>
        <button (click)="createAutomation($event)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          <i class="fas fa-plus mr-2"></i>
          Nova Automação
        </button>
      </div>
      
      <!-- Lista de Automações -->
      <div *ngIf="getValidAutomations().length > 0" class="grid gap-4">
        <div 
          *ngFor="let automation of getValidAutomations()" 
          class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-900 mr-3">
                  {{ automation.name }}
                </h3>
                <span 
                  class="px-2 py-1 text-xs font-medium rounded-full"
                  [class.bg-green-100]="automation.active"
                  [class.text-green-800]="automation.active"
                  [class.bg-red-100]="!automation.active"
                  [class.text-red-800]="!automation.active">
                  {{ automation.active ? 'Ativa' : 'Inativa' }}
                </span>
              </div>
              
              <div class="space-y-2 mb-4">
                <p class="text-sm text-gray-600">
                  <i class="fas fa-bolt mr-2"></i>
                  <strong>Gatilho:</strong> {{ getTriggerDescription(automation.trigger) }}
                </p>
                <p class="text-sm text-gray-600">
                  <i class="fas fa-play mr-2"></i>
                  <strong>Ações:</strong> {{ getActionsCount(automation.actions) }} ação(ões) configurada(s)
                </p>
              </div>
              
              <div class="flex items-center text-xs text-gray-500 space-x-4">
                <span>
                  <i class="far fa-calendar-alt mr-1"></i>
                  Criada em {{ formatDate(automation.createdAt) }}
                </span>
                <span *ngIf="automation.lastExecuted">
                  <i class="fas fa-play mr-1"></i>
                  Última execução: {{ formatDate(automation.lastExecuted) }}
                </span>
              </div>
            </div>
            
            <div class="flex items-center space-x-2 ml-4">
              <button 
                (click)="showAutomationHistory(automation, $event)"
                class="text-gray-500 hover:text-blue-600 px-3 py-1 text-sm font-medium"
                title="Ver Histórico">
                <i class="fas fa-history mr-1"></i>
                Histórico
              </button>
              <button 
                (click)="editAutomation(automation, $event)"
                class="text-blue-600 hover:text-blue-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-edit mr-1"></i>
                Editar
              </button>
              <button 
                (click)="toggleAutomation(automation)"
                class="px-3 py-1 text-sm font-medium"
                [class.text-red-600]="automation.active"
                [class.hover:text-red-800]="automation.active"
                [class.text-green-600]="!automation.active"
                [class.hover:text-green-800]="!automation.active">
                <i class="fas mr-1" [class.fa-pause]="automation.active" [class.fa-play]="!automation.active"></i>
                {{ automation.active ? 'Pausar' : 'Ativar' }}
              </button>
              <button 
                (click)="openDeleteAutomationConfirm(automation, $event)"
                class="text-red-600 hover:text-red-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-trash mr-1"></i>
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="getValidAutomations().length === 0" class="bg-white rounded-lg shadow p-6">
        <div class="text-center py-12 text-gray-500">
          <i class="fas fa-cogs text-6xl mb-4"></i>
          <h3 class="text-xl font-semibold mb-2">Nenhuma automação encontrada</h3>
          <p>Configure automações para disparar ações quando leads mudarem de fase</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Flow Tab - Novo Editor Simplificado -->
  <div *ngIf="!isLoading && activeTab === 'flow'" class="p-4 md:p-8">
    <div class="w-full mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Fluxo de Transições</h2>
        <div class="flex items-center gap-2">
          <button (click)="showCreateColumnModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium transition-colors" title="Nova fase">
            <i class="fas fa-plus mr-2"></i>
            Nova Fase
          </button>
          <button (click)="saveFlowConfig()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            <i class="fas fa-save mr-2"></i>
            Salvar Fluxo
          </button>
        </div>
      </div>

      <!-- Lista horizontal de fases com reordenação -->
      <div class="relative w-full">
        <div #flowScroller class="flow-scroll">
          <div cdkDropList [cdkDropListData]="flowOrder" (cdkDropListDropped)="onFlowReorder($event)" (cdkDropListEntered)="onDragEntered()" (cdkDropListExited)="onDragExited()" class="inline-flex items-center gap-6 p-2 whitespace-nowrap min-w-max flow-row w-max">
          <ng-container *ngFor="let phaseId of flowOrder; let i = index">
          <!-- Phase card -->
          <div cdkDrag (cdkDragStarted)="onDragStarted(phaseId)" (cdkDragEnded)="onDragEnded(phaseId)" class="min-w-[300px] max-w-[340px] flow-phase-card cursor-pointer" [attr.id]="'phase-'+phaseId" [style.--phase-color]="getColumnById(phaseId)?.color || '#94a3b8'" (click)="onPhaseCardClick(phaseId, $event)">
            <div class="px-3 py-2 bg-gray-50 rounded-t-lg flex items-center justify-between">
              <div class="font-medium text-gray-800 truncate">{{ getColumnById(phaseId)?.name }}</div>
              <div class="flex items-center gap-2">
                <button 
                  *ngIf="i > 0" 
                  (click)="movePhaseUp(i, $event)" 
                  class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                  title="Mover para esquerda">
                  <i class="fas fa-chevron-left text-xs"></i>
                </button>
                <button 
                  *ngIf="i < flowOrder.length - 1" 
                  (click)="movePhaseDown(i, $event)" 
                  class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                  title="Mover para direita">
                  <i class="fas fa-chevron-right text-xs"></i>
                </button>
                <i class="fas fa-grip-vertical text-gray-400" cdkDragHandle title="Arraste para reordenar"></i>
              </div>
            </div>
            <div class="p-3 text-sm space-y-3">
              <div *ngIf="hasOutgoingConnections(phaseId); else noConnections" class="pt-0">
                <div class="text-xs text-gray-500 mb-1">Conexões:</div>
                <div class="space-y-1">
                  <div *ngFor="let e of getOutgoingConnections(phaseId)" class="flex items-center justify-between text-xs">
                    <span class="truncate">{{ getEdgeArrow(e) }} {{ getColumnById(e.toId)?.name || e.toId }}</span>
                    <button class="text-red-600 hover:text-red-700" (click)="removeEdge(e); $event.stopPropagation()" title="Remover">
                      <i class="fas fa-xmark"></i>
                    </button>
                  </div>
                </div>
              </div>
              <ng-template #noConnections>
                <div class="text-xs text-gray-400">Sem conexões para esta fase</div>
              </ng-template>

              <!-- Footer action row: form, automations, connection -->
              <div class="pt-2 border-t border-gray-100 flex items-center justify-end gap-3 text-base">
                <button class="text-blue-600 hover:text-blue-700" title="Formulário da fase" (click)="showColumnForm(getColumnById(phaseId)!); $event.stopPropagation()">
                  <i class="fas fa-list-check"></i>
                </button>
                <button class="text-purple-600 hover:text-purple-700" title="Automações da fase" (click)="openPhaseAutomations(phaseId); $event.stopPropagation()">
                  <i class="fas fa-gears"></i>
                </button>
                <button *ngIf="!pendingFromId" class="text-indigo-600 hover:text-indigo-700" title="Iniciar conexão" (click)="beginEdge(phaseId); $event.stopPropagation()">
                  <i class="fas fa-circle-dot"></i>
                </button>
                <button *ngIf="pendingFromId && pendingFromId!==phaseId" class="text-indigo-600 hover:text-indigo-700" title="Conectar aqui" (click)="completeEdge(phaseId); $event.stopPropagation()">
                  <i class="fas fa-bullseye"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Connector removed -->
          </ng-container>
        </div>
        </div>
        <!-- custom persistent scrollbar outside the scroller -->
        <div class="flow-custombar mt-1" #flowCustomBar (mousedown)="onFlowBarPointerDown($event)" (touchstart)="onFlowBarTouchStart($event)">
          <div class="flow-thumb" [style.width.%]="flowThumbPercent" [style.left.%]="flowThumbLeftPercent"></div>
        </div>
      </div>

      <!-- Automations drawer inside Flow -->
      <div *ngIf="selectedPhaseIdForAutomations" class="mt-4 p-4 border rounded-lg bg-white shadow">
        <div class="flex justify-between items-center mb-3">
          <div class="font-semibold">Automações da fase: {{ getColumnById(selectedPhaseIdForAutomations!)?.name }}</div>
          <button class="text-gray-600 hover:text-gray-900" (click)="closePhaseAutomations()"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-2">
          <div *ngFor="let a of getAutomationsForPhase(selectedPhaseIdForAutomations!)" class="p-3 border rounded">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">{{ a.name || 'Automação sem nome' }}</div>
                <div class="text-xs text-gray-500">Trigger: {{ getTriggerDescription(a) }}</div>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs flex items-center gap-1">
                  <input type="checkbox" [checked]="a.active" (change)="toggleAutomation(a)" /> Ativa
                </label>
                <button class="text-blue-600 text-sm" (click)="editAutomation(a)">Editar</button>
                <button class="text-red-600 text-sm" (click)="openDeleteAutomationConfirm(a, $event)">Excluir</button>
              </div>
            </div>
          </div>
          <div class="pt-2">
            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm" (click)="createAutomationForPhase(selectedPhaseIdForAutomations!)">
              <i class="fas fa-plus mr-1"></i> Nova automação nesta fase
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmação de exclusão de automação -->
  <div *ngIf="showAutomationDeleteConfirm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" (click)="cancelDeleteAutomation()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Excluir automação</h3>
      <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir a automação
        <strong>{{ automationPendingDelete?.name || 'sem nome' }}</strong>? Esta ação não pode ser desfeita.</p>
      <div class="flex justify-end gap-3">
        <button class="px-4 py-2 rounded-lg border border-gray-300" (click)="cancelDeleteAutomation()">Cancelar</button>
        <button class="px-4 py-2 rounded-lg bg-red-600 text-white" (click)="confirmDeleteAutomation()">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Reports Tab -->
  <div *ngIf="!isLoading && activeTab === 'reports'">
    <app-reports 
      [boardId]="boardId" 
      [ownerId]="ownerId">
    </app-reports>
  </div>

  <!-- Outbox/Caixa de Saída Tab -->
  <div *ngIf="!isLoading && activeTab === 'outbox'" class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Caixa de Saída</h2>
        <div class="flex space-x-2">
          <button 
            (click)="clearOutbox()"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            <i class="fas fa-trash mr-2"></i>
            Limpar
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow">
        <!-- Tabs de status de email -->
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-6">
            <button 
              *ngFor="let status of emailStatuses"
              (click)="activeEmailStatus = status.id"
              class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
              [class.border-blue-500]="activeEmailStatus === status.id"
              [class.text-blue-600]="activeEmailStatus === status.id"
              [class.border-transparent]="activeEmailStatus !== status.id"
              [class.text-gray-500]="activeEmailStatus !== status.id">
              {{ status.name }}
              <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">
                {{ status.count }}
              </span>
            </button>
          </nav>
        </div>

        <!-- Lista de emails -->
        <div class="p-6">
          <div *ngIf="getFilteredEmails().length === 0" class="text-center py-12 text-gray-500">
            <i class="fas fa-paper-plane text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Nenhum email encontrado</h3>
            <p>Emails enviados aparecerão aqui</p>
          </div>

          <div *ngIf="getFilteredEmails().length > 0" class="space-y-4">
            <div 
              *ngFor="let email of getFilteredEmails()" 
              class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center space-x-3">
                    <div 
                      class="w-3 h-3 rounded-full"
                      [class.bg-yellow-400]="!email.delivery || email.delivery.state === 'PENDING'"
                      [class.bg-green-400]="email.delivery?.state === 'SUCCESS'"
                      [class.bg-red-400]="email.delivery?.state === 'ERROR'">
                    </div>
                    <h4 class="font-medium text-gray-900">{{ email.subject || 'Sem assunto' }}</h4>
                    <span 
                      class="px-2 py-1 text-xs rounded-full"
                      [class.bg-yellow-100]="!email.delivery || email.delivery.state === 'PENDING'"
                      [class.text-yellow-800]="!email.delivery || email.delivery.state === 'PENDING'"
                      [class.bg-green-100]="email.delivery?.state === 'SUCCESS'"
                      [class.text-green-800]="email.delivery?.state === 'SUCCESS'"
                      [class.bg-red-100]="email.delivery?.state === 'ERROR'"
                      [class.text-red-800]="email.delivery?.state === 'ERROR'">
                      {{ getEmailStatusLabel(email) }}
                    </span>
                  </div>
                  <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                    <span><i class="fas fa-envelope mr-1"></i>Para: {{ email.to }}</span>
                    <span><i class="fas fa-clock mr-1"></i>{{ formatDateTime(getEmailDisplayDate(email)) }}</span>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <button 
                    (click)="viewEmail(email)"
                    class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button 
                    *ngIf="email.delivery?.state === 'ERROR' || !email.delivery"
                    (click)="retryEmail(email)"
                    class="text-green-600 hover:text-green-800">
                    <i class="fas fa-redo"></i>
                  </button>
                  <button 
                    (click)="openOutboxDeleteConfirm(email, $event)"
                    class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmação de exclusão da mensagem (Outbox) -->
  <div *ngIf="showOutboxDeleteConfirm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" (click)="cancelOutboxDelete()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Excluir mensagem</h3>
      <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir esta mensagem da Caixa de Saída? Esta ação não pode ser desfeita.</p>
      <div class="flex justify-end gap-3">
        <button class="px-4 py-2 rounded-lg border border-gray-300" (click)="cancelOutboxDelete()">Cancelar</button>
        <button class="px-4 py-2 rounded-lg bg-red-600 text-white" (click)="confirmOutboxDelete()">Excluir</button>
      </div>
    </div>
  </div>

  <!-- API Tab -->
  <div *ngIf="!isLoading && activeTab === 'api'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Configuração da API</h2>
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-600">Status:</span>
          <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded">
            <i class="fas fa-check-circle mr-1"></i>Ativa
          </span>
        </div>
      </div>
      
      <!-- Endpoint -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">
            <i class="fas fa-link mr-2 text-blue-500"></i>Endpoint para Novos Leads
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Use este endpoint para enviar novos leads diretamente para o seu kanban via API REST.
          </p>
          
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">URL do Endpoint:</span>
              <button 
                (click)="copyToClipboard(apiEndpoint)"
                class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-copy mr-1"></i>Copiar
              </button>
            </div>
            <code class="bg-blue-50 text-blue-800 text-sm p-2 rounded border block">
              {{ apiEndpoint }}
            </code>
          </div>
        </div>
        
        <!-- Token de Autenticação -->
        <div class="p-6 border-b border-gray-200">
          <h4 class="text-md font-semibold text-gray-900 mb-2">
            <i class="fas fa-key mr-2 text-yellow-500"></i>Token de Autenticação
          </h4>
          <p class="text-sm text-gray-600 mb-3">
            Inclua este token no header <code class="bg-gray-100 px-1 rounded">Authorization</code> de suas requisições.
          </p>
          
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Bearer Token:</span>
              <button 
                (click)="copyToClipboard(apiToken)"
                class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-copy mr-1"></i>Copiar
              </button>
            </div>
            <code class="bg-yellow-50 text-yellow-800 text-sm p-2 rounded border block font-mono">
              {{ apiToken }}
            </code>
          </div>
        </div>
        
        <!-- Exemplo de Requisição -->
        <div class="p-6">
          <h4 class="text-md font-semibold text-gray-900 mb-2">
            <i class="fas fa-code mr-2 text-green-500"></i>Exemplo de Requisição
          </h4>
          <p class="text-sm text-gray-600 mb-3">
            Exemplo de como enviar um novo lead via POST request:
          </p>
          
          <div class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto">
            <pre class="text-sm"><code>POST {{ apiEndpoint }}
Content-Type: application/json
Authorization: Bearer {{ apiToken }}

{{ apiExampleJson }}</code></pre>
          </div>
        </div>
      </div>
      
      <!-- Webhooks -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">
            <i class="fas fa-broadcast-tower mr-2 text-purple-500"></i>Webhooks (Em breve)
          </h3>
          <p class="text-sm text-gray-600">
            Receba notificações quando leads mudarem de fase, forem criados ou atualizados.
          </p>
        </div>
        
        <div class="p-6">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-construction text-4xl mb-3"></i>
            <h4 class="font-semibold mb-2">Funcionalidade em Desenvolvimento</h4>
            <p class="text-sm">Webhooks estarão disponíveis em breve para integração avançada.</p>
          </div>
        </div>
      </div>
      
      <!-- Documentação -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">
          <i class="fas fa-book mr-2"></i>Documentação da API
        </h3>
        <div class="space-y-3 text-sm text-blue-800">
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Método:</strong> POST para criar novos leads
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Content-Type:</strong> application/json obrigatório
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Autenticação:</strong> Bearer token no header Authorization
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Campos obrigatórios:</strong> companyName, contactName, contactEmail
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Resposta de sucesso:</strong> Status 201 com dados do lead criado
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile board: stages list + cards feed -->
  <div *ngIf="!isLoading && activeTab === 'kanban'" class="mobile-board">
    <div class="p-4 space-y-3">
      <!-- Mobile filters -->
      <div class="flex gap-2 overflow-x-auto pb-2">
        <div class="relative flex-1 max-w-xs">
          <input
            type="text"
            placeholder="Buscar..."
            [(ngModel)]="filterQuery"
            (input)="applyFilters()"
            class="w-full pl-8 pr-8 py-2 border border-gray-200 rounded-full text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [class.border-blue-200]="filterQuery"
            [class.bg-blue-50]="filterQuery">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
          <button 
            *ngIf="filterQuery"
            (click)="filterQuery = ''; applyFilters()"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 p-1">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>
        
        <button (click)="toggleOnlyMine()" 
                class="px-3 py-2 rounded-full text-sm transition-colors flex items-center gap-1"
                [class.bg-blue-100]="filterOnlyMine" 
                [class.text-blue-700]="filterOnlyMine" 
                [class.bg-gray-100]="!filterOnlyMine" 
                [class.text-gray-600]="!filterOnlyMine">
          <i class="fas fa-user" [class.fa-user-check]="filterOnlyMine"></i>
          Meus cards
        </button>
        
        
        <!-- Botão para mostrar filtros avançados -->
        <button (click)="showAdvancedFilters = !showAdvancedFilters" 
                class="px-3 py-2 rounded-full text-sm flex items-center gap-2 transition-colors"
                [class.bg-purple-100]="getActiveDynamicFiltersCount() > 0"
                [class.text-purple-700]="getActiveDynamicFiltersCount() > 0"
                [class.bg-gray-100]="getActiveDynamicFiltersCount() === 0"
                [class.text-gray-600]="getActiveDynamicFiltersCount() === 0">
          <i class="fas fa-sliders-h"></i>
          <span>Avançado</span>
          <span *ngIf="getActiveDynamicFiltersCount() > 0" class="bg-purple-200 text-purple-800 px-1.5 py-0.5 rounded-full text-xs">
            {{ getActiveDynamicFiltersCount() }}
          </span>
        </button>
        
        <button *ngIf="hasActiveFilters()" 
                (click)="clearFilters()" 
                class="px-3 py-2 bg-red-100 text-red-700 rounded-full text-sm hover:bg-red-200 transition-colors flex items-center gap-1">
          <i class="fas fa-times"></i>
          Limpar
        </button>
      </div>
      
      <!-- Filtros Avançados (Campos Dinâmicos) -->
      <div *ngIf="showAdvancedFilters && availableFilterFields.length > 0" 
           class="bg-gray-50 rounded-lg p-4 space-y-3 border">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-medium text-gray-700 flex items-center gap-2">
            <i class="fas fa-filter text-purple-600"></i>
            Filtros por Campos
          </h4>
          <button (click)="showAdvancedFilters = false" 
                  class="text-gray-400 hover:text-gray-600 p-1">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-1 gap-3">
          <div *ngFor="let field of availableFilterFields" 
               class="flex items-center gap-3">
            <label class="text-sm text-gray-600 min-w-0 flex-1">
              {{ field.label }}
            </label>
            
            <!-- Campo de texto/email/tel -->
            <input *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'tel'"
                   type="text"
                   [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
                   [value]="getDynamicFilterValue(field.name)"
                   (input)="setDynamicFilter(field.name, $event.target.value)"
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            
            <!-- Campo de número -->
            <input *ngIf="field.type === 'number'"
                   type="number"
                   [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
                   [value]="getDynamicFilterValue(field.name)"
                   (input)="setDynamicFilter(field.name, $event.target.value)"
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            
            <!-- Campo de data -->
            <input *ngIf="field.type === 'date'"
                   type="date"
                   [value]="getDynamicFilterValue(field.name)"
                   (change)="setDynamicFilter(field.name, $event.target.value)"
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            
            <!-- Checkbox -->
            <label *ngIf="field.type === 'checkbox'" 
                   class="flex items-center gap-2 flex-1">
              <input type="checkbox"
                     [checked]="getDynamicFilterValue(field.name)"
                     (change)="setDynamicFilter(field.name, $event.target.checked)"
                     class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              <span class="text-sm text-gray-600">Apenas marcados</span>
            </label>
            
            <!-- Select/Radio/Temperatura (dropdown com opções) -->
            <select *ngIf="field.type === 'select' || field.type === 'radio' || field.type === 'temperatura'"
                    [value]="getDynamicFilterValue(field.name)"
                    (change)="onDynamicFilterChange(field.name, $event)"
                    class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
              <option value="">Todos</option>
              <option *ngFor="let option of getFieldOptions(field)" [value]="option">
                {{ option }}
              </option>
            </select>
            
            <!-- Botão para remover filtro específico -->
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-1 text-red-400 hover:text-red-600 transition-colors">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
        
        <div *ngIf="getActiveDynamicFiltersCount() > 0" 
             class="text-xs text-purple-600 flex items-center gap-1 pt-2 border-t">
          <i class="fas fa-info-circle"></i>
          <span>{{ getActiveDynamicFiltersCount() }} filtro(s) ativo(s) por campos</span>
        </div>
      </div>
      
      <!-- Filter status indicator -->
      <div *ngIf="hasActiveFilters()" class="mt-2 text-xs text-blue-600 flex items-center gap-1">
        <i class="fas fa-filter"></i>
        <span>Filtros ativos</span>
        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
          {{ (filterQuery ? 1 : 0) + (filterOnlyMine ? 1 : 0) + getActiveDynamicFiltersCount() }}
        </span>
      </div>

      <!-- Stages as accordion list -->
      <div class="space-y-2">
        <div *ngFor="let column of columns" class="rounded-2xl border border-gray-200 bg-white">
          <button (click)="toggleMobileColumn(column.id!)" class="w-full px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-block w-3 h-3 rounded-full" [style.background-color]="column.color || '#22c55e'"></span>
              <div class="font-semibold text-gray-800">{{ column.name }}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">{{ getLeadsForColumn(column.id!).length }}</span>
              <i class="fas" [class.fa-chevron-down]="!isMobileColumnOpen(column.id!)" [class.fa-chevron-up]="isMobileColumnOpen(column.id!)"></i>
            </div>
          </button>
          <div *ngIf="isMobileColumnOpen(column.id!)" class="px-4 pb-4">
            <div class="space-y-3">
              <div *ngFor="let lead of getLeadsForColumn(column.id!)" class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm">
                <div class="text-base font-bold text-gray-900 mb-1">{{ lead.fields['companyName'] || 'Sem título' }}</div>
                <div class="text-[13px] text-gray-500 mb-2" *ngIf="getLeadResponsibleName(lead)">
                  {{ getLeadResponsibleName(lead) }}
                </div>
                <div class="text-sm text-gray-700" *ngIf="lead.fields?.['contactName']">
                  <span class="uppercase tracking-wide text-gray-400 text-[11px]">NOME DO CONTATO</span><br>
                  {{ lead.fields['contactName'] }}
                </div>
                <div class="mt-3 flex items-center gap-5 text-xs text-gray-500">
                  <div class="flex items-center gap-1"><i class="far fa-comment"></i> 1</div>
                  <div class="flex items-center gap-1"><i class="far fa-clock text-orange-400"></i> {{ getDaysSince(lead.createdAt) }}d</div>
                  <div class="flex items-center gap-1"><i class="fas fa-history text-blue-500"></i> {{ getDaysSince(lead.movedToCurrentColumnAt) }}d</div>
                  <div class="flex items-center gap-1" *ngIf="getLeadDueDateLabel(lead)"><i class="far fa-calendar-check text-green-500"></i> {{ getLeadDueDateLabel(lead) }}</div>
                </div>
              </div>
              <div *ngIf="getLeadsForColumn(column.id!).length === 0" class="text-center text-gray-400 text-sm py-2">Nenhum registro nesta fase</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards feed (pipefy-like) -->
      <div class="mt-4 space-y-3">
        <div *ngFor="let lead of leads" class="bg-white rounded-2xl border border-gray-200 p-4 shadow-sm">
          <div class="text-base font-bold text-gray-900 mb-1">{{ lead.fields['companyName'] || 'Sem título' }}</div>
          <div class="text-[13px] text-gray-500 mb-2" *ngIf="getLeadResponsibleName(lead)">
            {{ getLeadResponsibleName(lead) }}
          </div>
          <div class="text-sm text-gray-700" *ngIf="lead.fields?.['contactName']">
            <span class="uppercase tracking-wide text-gray-400 text-[11px]">NOME DO CONTATO</span><br>
            {{ lead.fields['contactName'] }}
          </div>
          <div class="mt-3 flex items-center gap-5 text-xs text-gray-500">
            <div class="flex items-center gap-1"><i class="far fa-comment"></i> 1</div>
            <div class="flex items-center gap-1"><i class="far fa-clock text-orange-400"></i> {{ getDaysSince(lead.createdAt) }}d</div>
            <div class="flex items-center gap-1"><i class="fas fa-history text-blue-500"></i> {{ getDaysSince(lead.movedToCurrentColumnAt) }}d</div>
            <div class="flex items-center gap-1" *ngIf="getLeadDueDateLabel(lead)"><i class="far fa-calendar-check text-green-500"></i> {{ getLeadDueDateLabel(lead) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sticky bottom action -->
    <div class="fixed bottom-4 inset-x-4 z-40 md:hidden">
      <button (click)="showCreateLeadModal()" class="w-full h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-semibold shadow-lg flex items-center justify-center gap-2">
        <span class="inline-flex w-6 h-6 items-center justify-center bg-blue-700/60 rounded-full"><i class="fas fa-plus text-xs"></i></span>
        Novo lead
      </button>
    </div>
  </div>

  <!-- Modal de Lead -->
  <app-lead-modal 
    [ownerId]="ownerId"
    [boardId]="boardId"
    [columns]="columns"
    (leadCreated)="onLeadCreated()"
    (leadUpdated)="onLeadUpdated()"
    (closeModal)="onLeadUpdated()">
  </app-lead-modal>

  <!-- Modal de Coluna -->
  <app-column-modal 
    [ownerId]="ownerId"
    [boardId]="boardId"
    [columns]="columns"
    (columnCreated)="onColumnCreated()"
    (columnUpdated)="onColumnUpdated()"
    (columnDeleted)="onColumnDeleted()"
    (closeModal)="onColumnUpdated()">
  </app-column-modal>

  <!-- Modal de Formulário da Fase -->
  <app-phase-form-modal 
    [ownerId]="ownerId"
    [boardId]="boardId"
    (formConfigSaved)="onPhaseFormConfigSaved()"
    (closeModal)="onPhaseFormConfigSaved()">
  </app-phase-form-modal>

  <!-- Modal de Detalhes do Lead -->
  <app-lead-detail-modal 
    [ownerId]="ownerId"
    [boardId]="boardId"
    [columns]="columns"
    [users]="users"
    (leadUpdated)="onLeadUpdated()"
    (leadDeleted)="onLeadDeleted()"
    (closeModal)="onLeadUpdated()">
  </app-lead-detail-modal>

  <!-- Modal de Template -->
  <app-template-modal 
    [ownerId]="ownerId"
    [boardId]="boardId"
    (templateSaved)="onTemplateSaved()"
    (closeModal)="onTemplateSaved()">
  </app-template-modal>

  <!-- Modal de Automação -->
  <app-automation-modal
    *ngIf="showAutomationModal"
    [isVisible]="showAutomationModal"
    [automation]="selectedAutomation"
    [phases]="columns"
    [allowedTriggerTypes]="selectedPhaseIdForAutomations ? getAllowedTriggerTypesForPhase(selectedPhaseIdForAutomations) : null"
    [fixedPhaseId]="selectedPhaseIdForAutomations || null"
    [allowedTransitions]="flowConfig.allowed || {}"
    [emailTemplates]="emailTemplates"
    [users]="users"
    (closeModalEvent)="onCloseAutomationModal()"
    (saveAutomation)="onSaveAutomation($event)">
  </app-automation-modal>

  <!-- Modal de Histórico de Automação -->
  <app-automation-history-modal
    [isVisible]="showHistoryModal"
    [automationId]="selectedAutomationForHistory?.id || ''"
    [automationName]="selectedAutomationForHistory?.name || ''"
    [ownerId]="ownerId"
    [boardId]="boardId"
    [leads]="leads"
    (closeModalEvent)="onCloseHistoryModal()">
  </app-automation-history-modal>
</app-main-layout>  