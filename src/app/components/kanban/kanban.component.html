<app-main-layout>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center items-center py-20">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
  </div>

  <!-- Tabs Navigation with Search -->
  <nav *ngIf="!isLoading" class="bg-white px-4 md:px-8 border-b border-gray-200 sticky top-0 z-30">
    <div class="flex justify-between items-center">
      <!-- Left side: Back Button and Search (Desktop only) -->
      <div class="hidden md:flex items-center space-x-4">
        <div class="flex items-center space-x-3">
          <!-- Back Button -->
          <button
            (click)="goToDashboard()"
            class="text-gray-500 hover:text-gray-700 p-1 rounded hover:bg-gray-100 transition-colors">
            <i class="fas fa-arrow-left"></i>
          </button>

          <!-- Search Field - Compact -->
          <div class="relative" *ngIf="activeTab === 'kanban'">
            <input
              type="text"
              [(ngModel)]="filterQuery"
              (ngModelChange)="onFilterQueryChange($event)"
              placeholder="Pesquisar..."
              class="w-64 pl-8 pr-10 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <i class="fas fa-search absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>

            <!-- Filter Button Inside Search -->
            <button
              (click)="toggleAdvancedFilters()"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 hover:bg-gray-100 rounded transition-colors"
              [class.text-blue-600]="showAdvancedFilters"
              [class.bg-blue-50]="showAdvancedFilters">
              <i class="fas fa-filter text-xs"></i>
              <span *ngIf="hasActiveFilters()" class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-3 h-3 flex items-center justify-center" style="font-size: 8px;">
                {{ getDynamicFilterCount() + (filterOnlyMine ? 1 : 0) }}
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile: Back Button only -->
      <div class="md:hidden flex items-center">
        <button
          (click)="goToDashboard()"
          class="text-gray-500 hover:text-gray-700 p-1 rounded hover:bg-gray-100 transition-colors">
          <i class="fas fa-arrow-left"></i>
        </button>
      </div>

      <!-- Center: Tab Navigation -->
      <div class="hidden md:flex space-x-8">
        <button
          *ngFor="let tab of tabs"
          (click)="switchTab(tab.id)"
          class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
          [class.border-blue-500]="activeTab === tab.id"
          [class.text-blue-600]="activeTab === tab.id"
          [class.border-transparent]="activeTab !== tab.id"
          [class.text-gray-500]="activeTab !== tab.id"
          [class.hover:text-gray-700]="activeTab !== tab.id">
          <i class="fas {{ tab.icon }} mr-2"></i>
          {{ tab.name }}
        </button>
      </div>

      <!-- Right side: Clear Filters Button -->
      <div class="hidden md:flex items-center space-x-2">
        <button 
          *ngIf="hasActiveFilters() && activeTab === 'kanban'"
          (click)="clearFilters()"
          class="px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 border border-red-300 rounded text-xs transition-colors">
          <i class="fas fa-times mr-1"></i>
          Limpar
        </button>
      </div>
    </div>
  </nav>

  <!-- Advanced Filters Modal -->
  <div *ngIf="showAdvancedFilters && activeTab === 'kanban'" 
       class="fixed top-20 left-4 w-full max-w-lg bg-white rounded-xl shadow-xl border border-gray-200 z-[9999]">
    <div class="p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Filtros Avan√ßados</h3>
        <button 
          (click)="toggleAdvancedFilters()"
          class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Quick Filter: Show Only Mine -->
      <div class="mb-6 p-3 bg-gray-50 rounded-lg">
        <label class="flex items-center space-x-2 cursor-pointer">
          <input 
            type="checkbox" 
            [(ngModel)]="filterOnlyMine"
            (ngModelChange)="toggleOnlyMine()"
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
          <span class="text-sm text-gray-700 font-medium">Mostrar apenas meus registros</span>
        </label>
      </div>
      
      <!-- Dynamic Filter Fields -->
      <div *ngIf="availableFilterFields.length > 0" class="space-y-4">
        <h4 class="text-sm font-medium text-gray-700 mb-3">Filtros Din√¢micos</h4>
        
        <div *ngFor="let field of availableFilterFields" class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">
            {{ field.label }}
          </label>
          
          <!-- Text/Email/Tel/Number Fields -->
          <input 
            *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'tel' || field.type === 'number' || field.type === 'cnpj' || field.type === 'cpf'"
            [type]="field.type === 'number' ? 'number' : 'text'"
            [value]="dynamicFilters[field.name] || ''"
            (input)="setDynamicFilter(field.name, $any($event.target).value)"
            [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          
          <!-- Date Fields -->
          <input 
            *ngIf="field.type === 'date'"
            type="date"
            [value]="dynamicFilters[field.name] || ''"
            (input)="setDynamicFilter(field.name, $any($event.target).value)"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          
          <!-- Select/Radio Fields -->
          <select 
            *ngIf="field.type === 'select' || field.type === 'radio'"
            [value]="dynamicFilters[field.name] || ''"
            (change)="setDynamicFilter(field.name, $any($event.target).value)"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">Todos</option>
            <option *ngFor="let option of getFieldOptions(field)" [value]="option">
              {{ option }}
            </option>
          </select>
          
          <!-- Temperatura Field -->
          <select 
            *ngIf="field.type === 'temperatura'"
            [value]="dynamicFilters[field.name] || ''"
            (change)="setDynamicFilter(field.name, $any($event.target).value)"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">Todas as temperaturas</option>
            <option value="Quente">üî• Quente</option>
            <option value="Morno">üå°Ô∏è Morno</option>
            <option value="Frio">‚ùÑÔ∏è Frio</option>
          </select>
          
          <!-- Checkbox Fields -->
          <div *ngIf="field.type === 'checkbox'" class="flex items-center space-x-2">
            <input 
              type="checkbox"
              [checked]="dynamicFilters[field.name] === true"
              (change)="setDynamicFilter(field.name, $any($event.target).checked)"
              class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="text-sm text-gray-700">Apenas marcados</span>
          </div>
        </div>
      </div>
      
      <!-- No Fields Available -->
      <div *ngIf="availableFilterFields.length === 0" class="text-center py-6">
        <i class="fas fa-filter text-gray-300 text-3xl mb-3"></i>
        <p class="text-gray-500 text-sm">
          Nenhum campo configurado para filtros.<br>
          Configure campos com "Mostrar em filtros" ativado no formul√°rio.
        </p>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
        <button 
          (click)="clearFilters()"
          class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
          Limpar
        </button>
        <button 
          (click)="toggleAdvancedFilters()"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          Aplicar
        </button>
      </div>
    </div>
  </div>

  <!-- Desktop Kanban Board Tab -->
  <div *ngIf="!isLoading && activeTab === 'kanban'"
       class="kanban-board desktop-board"
       #kanbanBoard
       (mousedown)="onKanbanMouseDown($event)"
       (mousemove)="onKanbanMouseMove($event)"
       (mouseup)="onKanbanMouseUp()"
       (mouseleave)="onKanbanMouseLeave()">
    <div 
      *ngFor="let column of columns" 
      class="kanban-column"
      [style.background-color]="'#e2e8f0'">
      
      <!-- Column Header -->
      <div 
        class="kanban-column-header"
        [style.border-top-color]="getColumnBorderColor(column)">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <h3 class="font-semibold text-gray-800">{{ column.name }}</h3>
            <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">
              {{ getLeadsForColumn(column.id!).length }}
            </span>
            <span *ngIf="getAutomationCount(column.id!) > 0" class="ml-2 inline-flex items-center text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800" title="Automa√ß√µes ativas nesta fase">
              <i class="fas fa-bolt mr-1"></i>{{ getAutomationCount(column.id!) }}
            </span>
          </div>
          
          
        </div>
      </div>

      <!-- Cards Container -->
      <div 
        class="kanban-cards"
        cdkDropList
        [id]="'column-' + column.id"
        [cdkDropListData]="displayedLeadsByColumn[column.id!] || []"
        [cdkDropListConnectedTo]="getColumnConnectedTo()"
        (cdkDropListDropped)="onLeadDrop($event)">
        
        <div
          *ngFor="let lead of (displayedLeadsByColumn[column.id!] || []); trackBy: trackByLeadId"
          class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200 cursor-pointer mb-3 p-4 border-l-4"
          [class]="getSlaStatus(lead).borderClass || getLeadPriorityClass(lead)"
          style="position: relative;"
          cdkDrag
          [cdkDragDisabled]="!cardMoveEnabled"
          [cdkDragData]="lead.id"
          (cdkDragStarted)="onLeadDragStarted()"
          (cdkDragEnded)="onLeadDragEnded()">

          <!-- Overlay invis√≠vel para capturar cliques em todo o card -->
          <div
            (click)="onCardClick(lead, $event)"
            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; cursor: pointer;">
          </div>

          <!-- Campos configurados para exibir no card -->
          <div class="space-y-2 mb-3" style="position: relative; z-index: 0; pointer-events: none;">
            <div *ngFor="let item of getCardFieldsForLead(lead); let i = index" class="text-xs">
              <!-- Outros campos: exibir normal (temperatura vai para o rodap√©) -->
              <div *ngIf="item.type !== 'temperatura'">
                <!-- Primeiro campo como t√≠tulo principal -->
                <div *ngIf="i === 0" class="font-semibold text-gray-900 text-sm truncate mb-2">
                  {{ item.value || 'Sem t√≠tulo' }}
                </div>
                <!-- Demais campos -->
                <div *ngIf="i > 0">
                  <div class="font-medium text-gray-600 mb-0.5">{{ item.label }}</div>
                  <div class="text-gray-900 truncate">{{ item.value }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- SLA Status -->
          <div *ngIf="getSlaStatus(lead).text" class="mb-3" style="position: relative; z-index: 0; pointer-events: none;">
            <div class="flex items-center text-xs font-medium"
                 [class]="getSlaStatus(lead).colorClass">
              <i class="fas fa-clock w-3 h-3 mr-1"></i>
              <span>{{ getSlaStatus(lead).text }}</span>
            </div>
          </div>

          <!-- Temperatura (sempre vis√≠vel se existir) -->
          <div *ngIf="getTemperatureGlobalItem(lead) as temp" class="mb-3" style="position: relative; z-index: 0; pointer-events: none;">
            <div class="flex items-center text-xs font-medium">
              <span [ngClass]="{
                'bg-red-500': temp.value === 'Quente',
                'bg-yellow-500': temp.value === 'Morno',
                'bg-blue-500': temp.value === 'Frio'
              }" class="w-2 h-2 rounded-full mr-1"></span>
              <span>{{ temp.value }}</span>
            </div>
          </div>

          <!-- Card Footer -->
          <div class="flex items-center justify-between" style="position: relative; z-index: 0; pointer-events: none;">
            <div class="flex items-center gap-3 text-xs text-gray-500">
              <!-- Coment√°rios count -->
              <div class="flex items-center" *ngIf="lead.historyCommentsCount as c"><i class="far fa-comment mr-1"></i><span>{{ c || 0 }}</span></div>
              <!-- Anexos count -->
              <div class="flex items-center" *ngIf="lead.attachmentsCount as a"><i class="fas fa-paperclip mr-1"></i><span>{{ a || 0 }}</span></div>
            </div>
            <div class="flex items-center text-xs text-gray-500">
              <i class="far fa-calendar-alt w-3 h-3 mr-1"></i>
              <span>{{ formatDateTime(lead.createdAt) }}</span>
            </div>
          </div>

          <!-- Description/Notes Preview -->
          <div *ngIf="lead.fields?.['description']" class="mt-2 pt-2 border-t border-gray-100" style="position: relative; z-index: 0; pointer-events: none;">
            <p class="text-xs text-gray-600 line-clamp-2">
              {{ lead.fields['description'] }}
            </p>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="getLeadsForColumn(column.id!).length === 0" 
             class="text-center py-6 text-gray-400">
          <i class="fas fa-inbox text-2xl mb-2"></i>
          <p class="text-sm">Nenhum registro nesta fase</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√£o flutuante √∫nico: Novo registro (Desktop only) -->
  <button
    *ngIf="!isLoading && activeTab === 'kanban'"
    (click)="showCreateLeadModal()"
    class="hidden md:flex fixed left-4 bottom-4 z-40 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-full shadow-lg items-center gap-2">
    <i class="fas fa-plus"></i>
    Novo registro
  </button>

  <!-- Initial Form Tab -->
  <div *ngIf="!isLoading && activeTab === 'initial-form'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Formul√°rio inicial do quadro</h2>

      <app-visual-form-builder
        [fields]="initialFormFields"
        (fieldsChanged)="onInitialFieldsChanged($event)">
      </app-visual-form-builder>

      <div class="flex justify-end mt-6">
        <button class="px-4 py-2 text-white rounded-lg" [style.background-color]="getPrimaryColor()" (click)="saveInitialForm()">
          Salvar
        </button>
      </div>
    </div>
  </div>

  <!-- Configura√ß√£o de formul√°rio da fase removida daqui; usar √≠cone na pr√≥pria coluna -->

  <!-- Empty State - No Columns -->
  <div *ngIf="!isLoading && activeTab === 'kanban' && columns.length === 0" class="text-center py-20">
    <div class="max-w-md mx-auto">
      <i class="fas fa-columns text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhuma coluna encontrada</h3>
      <p class="text-gray-600">
        Este quadro ainda n√£o possui colunas configuradas.
      </p>
    </div>
  </div>

  <!-- Templates Tab -->
  <div *ngIf="!isLoading && activeTab === 'templates'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Templates de Email</h2>
        <button (click)="createTemplate()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          <i class="fas fa-plus mr-2"></i>
          Novo Template
        </button>
      </div>
      
      <!-- Lista de Templates -->
      <div *ngIf="emailTemplates.length > 0" class="grid gap-4">
        <div 
          *ngFor="let template of emailTemplates" 
          class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">
                {{ template.name || 'Template sem nome' }}
              </h3>
              <p class="text-sm text-gray-600 mb-3">
                <strong>Assunto:</strong> {{ template.subject || 'Sem assunto' }}
              </p>
              <p class="text-xs text-gray-500 mb-4">
                <strong>Para:</strong> {{ template.recipients || 'N√£o especificado' }}
              </p>
              <div class="flex items-center text-xs text-gray-500 space-x-4">
                <span>
                  <i class="far fa-calendar-alt mr-1"></i>
                  Criado em {{ formatDate(template.createdAt) }}
                </span>
                <span *ngIf="template.updatedAt">
                  <i class="fas fa-edit mr-1"></i>
                  Atualizado em {{ formatDate(template.updatedAt) }}
                </span>
              </div>
            </div>
            
            <div class="flex items-center space-x-2 ml-4">
              <button 
                (click)="editTemplate(template)"
                class="text-blue-600 hover:text-blue-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-edit mr-1"></i>
                Editar
              </button>
              <button 
                (click)="deleteTemplate(template)"
                class="text-red-600 hover:text-red-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-trash mr-1"></i>
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="emailTemplates.length === 0" class="bg-white rounded-lg shadow p-6">
        <div class="text-center py-12 text-gray-500">
          <i class="fas fa-envelope text-6xl mb-4"></i>
          <h3 class="text-xl font-semibold mb-2">Nenhum template encontrado</h3>
          <p>Crie templates personalizados para automa√ß√µes de email</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Automations Tab -->
  <div *ngIf="!isLoading && activeTab === 'automations'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Automa√ß√µes</h2>
        <button (click)="createAutomation($event)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          <i class="fas fa-plus mr-2"></i>
          Nova Automa√ß√£o
        </button>
      </div>
      
      <!-- Lista de Automa√ß√µes -->
      <div *ngIf="getValidAutomations().length > 0" class="grid gap-4">
        <div 
          *ngFor="let automation of getValidAutomations()" 
          class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-900 mr-3">
                  {{ automation.name }}
                </h3>
                <span 
                  class="px-2 py-1 text-xs font-medium rounded-full"
                  [class.bg-green-100]="automation.active"
                  [class.text-green-800]="automation.active"
                  [class.bg-red-100]="!automation.active"
                  [class.text-red-800]="!automation.active">
                  {{ automation.active ? 'Ativa' : 'Inativa' }}
                </span>
              </div>
              
              <div class="space-y-2 mb-4">
                <p class="text-sm text-gray-600">
                  <i class="fas fa-bolt mr-2"></i>
                  <strong>Gatilho:</strong> {{ getTriggerDescription(automation.trigger) }}
                </p>
                <p class="text-sm text-gray-600">
                  <i class="fas fa-play mr-2"></i>
                  <strong>A√ß√µes:</strong> {{ getActionsCount(automation.actions) }} a√ß√£o(√µes) configurada(s)
                </p>
              </div>
              
              <div class="flex items-center text-xs text-gray-500 space-x-4">
                <span>
                  <i class="far fa-calendar-alt mr-1"></i>
                  Criada em {{ formatDate(automation.createdAt) }}
                </span>
                <span *ngIf="automation.lastExecuted">
                  <i class="fas fa-play mr-1"></i>
                  √öltima execu√ß√£o: {{ formatDate(automation.lastExecuted) }}
                </span>
              </div>
            </div>
            
            <div class="flex items-center space-x-2 ml-4">
              <button 
                (click)="showAutomationHistory(automation, $event)"
                class="text-gray-500 hover:text-blue-600 px-3 py-1 text-sm font-medium"
                title="Ver Hist√≥rico">
                <i class="fas fa-history mr-1"></i>
                Hist√≥rico
              </button>
              <button 
                (click)="editAutomation(automation, $event)"
                class="text-blue-600 hover:text-blue-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-edit mr-1"></i>
                Editar
              </button>
              <button 
                (click)="toggleAutomation(automation)"
                class="px-3 py-1 text-sm font-medium"
                [class.text-red-600]="automation.active"
                [class.hover:text-red-800]="automation.active"
                [class.text-green-600]="!automation.active"
                [class.hover:text-green-800]="!automation.active">
                <i class="fas mr-1" [class.fa-pause]="automation.active" [class.fa-play]="!automation.active"></i>
                {{ automation.active ? 'Pausar' : 'Ativar' }}
              </button>
              <button 
                (click)="openDeleteAutomationConfirm(automation, $event)"
                class="text-red-600 hover:text-red-800 px-3 py-1 text-sm font-medium">
                <i class="fas fa-trash mr-1"></i>
                Excluir
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="getValidAutomations().length === 0" class="bg-white rounded-lg shadow p-6">
        <div class="text-center py-12 text-gray-500">
          <i class="fas fa-cogs text-6xl mb-4"></i>
          <h3 class="text-xl font-semibold mb-2">Nenhuma automa√ß√£o encontrada</h3>
          <p>Configure automa√ß√µes para disparar a√ß√µes quando leads mudarem de fase</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Flow Tab - Novo Editor Simplificado -->
  <div *ngIf="!isLoading && activeTab === 'flow'" class="p-4 md:p-8">
    <div class="w-full mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Fluxo de Transi√ß√µes</h2>
        <div class="flex items-center gap-2">
          <button (click)="showCreateColumnModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium transition-colors" title="Nova fase">
            <i class="fas fa-plus mr-2"></i>
            Nova Fase
          </button>
          <button (click)="saveFlowConfig()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            <i class="fas fa-save mr-2"></i>
            Salvar Fluxo
          </button>
        </div>
      </div>

      <!-- Lista horizontal de fases com reordena√ß√£o -->
      <div class="relative w-full">
        <div #flowScroller class="flow-scroll">
          <div cdkDropList [cdkDropListData]="flowOrder" (cdkDropListDropped)="onFlowReorder($event)" (cdkDropListEntered)="onDragEntered()" (cdkDropListExited)="onDragExited()" class="inline-flex items-center gap-6 p-2 whitespace-nowrap min-w-max flow-row w-max">
          <ng-container *ngFor="let phaseId of flowOrder; let i = index">
          <!-- Phase card -->
          <div cdkDrag (cdkDragStarted)="onDragStarted(phaseId)" (cdkDragEnded)="onDragEnded(phaseId)" class="min-w-[300px] max-w-[340px] flow-phase-card cursor-pointer" [attr.id]="'phase-'+phaseId" [style.--phase-color]="getColumnById(phaseId)?.color || '#94a3b8'" (click)="onPhaseCardClick(phaseId, $event)">
            <div class="px-3 py-2 bg-gray-50 rounded-t-lg flex items-center justify-between">
              <div class="font-medium text-gray-800 truncate">{{ getColumnById(phaseId)?.name }}</div>
              <div class="flex items-center gap-2">
                <button 
                  *ngIf="i > 0" 
                  (click)="movePhaseUp(i, $event)" 
                  class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                  title="Mover para esquerda">
                  <i class="fas fa-chevron-left text-xs"></i>
                </button>
                <button 
                  *ngIf="i < flowOrder.length - 1" 
                  (click)="movePhaseDown(i, $event)" 
                  class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                  title="Mover para direita">
                  <i class="fas fa-chevron-right text-xs"></i>
                </button>
                <i class="fas fa-grip-vertical text-gray-400" cdkDragHandle title="Arraste para reordenar"></i>
              </div>
            </div>
            <div class="p-3 text-sm space-y-3">
              <div *ngIf="hasOutgoingConnections(phaseId); else noConnections" class="pt-0">
                <div class="text-xs text-gray-500 mb-1">Conex√µes:</div>
                <div class="space-y-1">
                  <div *ngFor="let e of getOutgoingConnections(phaseId)" class="flex items-center justify-between text-xs">
                    <span class="truncate">{{ getEdgeArrow(e) }} {{ getColumnById(e.toId)?.name || e.toId }}</span>
                    <button class="text-red-600 hover:text-red-700" (click)="removeEdge(e); $event.stopPropagation()" title="Remover">
                      <i class="fas fa-xmark"></i>
                    </button>
                  </div>
                </div>
              </div>
              <ng-template #noConnections>
                <div class="text-xs text-gray-400">Sem conex√µes para esta fase</div>
              </ng-template>

              <!-- Footer action row: form, automations, connection -->
              <div class="pt-2 border-t border-gray-100 flex items-center justify-end gap-3 text-base">
                <button class="text-blue-600 hover:text-blue-700" title="Formul√°rio da fase" (click)="showColumnForm(getColumnById(phaseId)!); $event.stopPropagation()">
                  <i class="fas fa-list-check"></i>
                </button>
                <button class="text-purple-600 hover:text-purple-700" title="Automa√ß√µes da fase" (click)="openPhaseAutomations(phaseId); $event.stopPropagation()">
                  <i class="fas fa-gears"></i>
                </button>
                <button *ngIf="!pendingFromId" class="text-indigo-600 hover:text-indigo-700" title="Iniciar conex√£o" (click)="beginEdge(phaseId); $event.stopPropagation()">
                  <i class="fas fa-circle-dot"></i>
                </button>
                <button *ngIf="pendingFromId && pendingFromId!==phaseId" class="text-indigo-600 hover:text-indigo-700" title="Conectar aqui" (click)="completeEdge(phaseId); $event.stopPropagation()">
                  <i class="fas fa-bullseye"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Connector removed -->
          </ng-container>
        </div>
        </div>
        <!-- custom persistent scrollbar outside the scroller -->
        <div class="flow-custombar mt-1" #flowCustomBar (mousedown)="onFlowBarPointerDown($event)" (touchstart)="onFlowBarTouchStart($event)">
          <div class="flow-thumb" [style.width.%]="flowThumbPercent" [style.left.%]="flowThumbLeftPercent"></div>
        </div>
      </div>

      <!-- Automations drawer inside Flow -->
      <div *ngIf="selectedPhaseIdForAutomations" class="mt-4 p-4 border rounded-lg bg-white shadow">
        <div class="flex justify-between items-center mb-3">
          <div class="font-semibold">Automa√ß√µes da fase: {{ getColumnById(selectedPhaseIdForAutomations!)?.name }}</div>
          <button class="text-gray-600 hover:text-gray-900" (click)="closePhaseAutomations()"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-2">
          <div *ngFor="let a of getAutomationsForPhase(selectedPhaseIdForAutomations!)" class="p-3 border rounded">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">{{ a.name || 'Automa√ß√£o sem nome' }}</div>
                <div class="text-xs text-gray-500">Trigger: {{ getTriggerDescription(a) }}</div>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-xs flex items-center gap-1">
                  <input type="checkbox" [checked]="a.active" (change)="toggleAutomation(a)" /> Ativa
                </label>
                <button class="text-blue-600 text-sm" (click)="editAutomation(a)">Editar</button>
                <button class="text-red-600 text-sm" (click)="openDeleteAutomationConfirm(a, $event)">Excluir</button>
              </div>
            </div>
          </div>
          <div class="pt-2">
            <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm" (click)="createAutomationForPhase(selectedPhaseIdForAutomations!)">
              <i class="fas fa-plus mr-1"></i> Nova automa√ß√£o nesta fase
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o de exclus√£o de automa√ß√£o -->
  <div *ngIf="showAutomationDeleteConfirm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" (click)="cancelDeleteAutomation()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Excluir automa√ß√£o</h3>
      <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir a automa√ß√£o
        <strong>{{ automationPendingDelete?.name || 'sem nome' }}</strong>? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="flex justify-end gap-3">
        <button class="px-4 py-2 rounded-lg border border-gray-300" (click)="cancelDeleteAutomation()">Cancelar</button>
        <button class="px-4 py-2 rounded-lg bg-red-600 text-white" (click)="confirmDeleteAutomation()">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Reports Tab -->
  <div *ngIf="!isLoading && activeTab === 'reports'">
    <app-reports 
      [boardId]="boardId" 
      [ownerId]="ownerId">
    </app-reports>
  </div>

  <!-- Outbox/Caixa de Sa√≠da Tab -->
  <div *ngIf="!isLoading && activeTab === 'outbox'" class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Caixa de Sa√≠da</h2>
        <div class="flex space-x-2">
          <button 
            (click)="clearOutbox()"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            <i class="fas fa-trash mr-2"></i>
            Limpar
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow">
        <!-- Tabs de status de email -->
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-6">
            <button 
              *ngFor="let status of emailStatuses"
              (click)="activeEmailStatus = status.id"
              class="py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200"
              [class.border-blue-500]="activeEmailStatus === status.id"
              [class.text-blue-600]="activeEmailStatus === status.id"
              [class.border-transparent]="activeEmailStatus !== status.id"
              [class.text-gray-500]="activeEmailStatus !== status.id">
              {{ status.name }}
              <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">
                {{ status.count }}
              </span>
            </button>
          </nav>
        </div>

        <!-- Lista de emails -->
        <div class="p-6">
          <div *ngIf="getFilteredEmails().length === 0" class="text-center py-12 text-gray-500">
            <i class="fas fa-paper-plane text-6xl mb-4"></i>
            <h3 class="text-xl font-semibold mb-2">Nenhum email encontrado</h3>
            <p>Emails enviados aparecer√£o aqui</p>
          </div>

          <div *ngIf="getFilteredEmails().length > 0" class="space-y-4">
            <div 
              *ngFor="let email of getFilteredEmails()" 
              class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center space-x-3">
                    <div 
                      class="w-3 h-3 rounded-full"
                      [class.bg-yellow-400]="!email.delivery || email.delivery.state === 'PENDING'"
                      [class.bg-green-400]="email.delivery?.state === 'SUCCESS'"
                      [class.bg-red-400]="email.delivery?.state === 'ERROR'">
                    </div>
                    <h4 class="font-medium text-gray-900">{{ email.subject || 'Sem assunto' }}</h4>
                    <span 
                      class="px-2 py-1 text-xs rounded-full"
                      [class.bg-yellow-100]="!email.delivery || email.delivery.state === 'PENDING'"
                      [class.text-yellow-800]="!email.delivery || email.delivery.state === 'PENDING'"
                      [class.bg-green-100]="email.delivery?.state === 'SUCCESS'"
                      [class.text-green-800]="email.delivery?.state === 'SUCCESS'"
                      [class.bg-red-100]="email.delivery?.state === 'ERROR'"
                      [class.text-red-800]="email.delivery?.state === 'ERROR'">
                      {{ getEmailStatusLabel(email) }}
                    </span>
                  </div>
                  <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                    <span><i class="fas fa-envelope mr-1"></i>Para: {{ email.to }}</span>
                    <span><i class="fas fa-clock mr-1"></i>{{ formatDateTime(getEmailDisplayDate(email)) }}</span>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <button 
                    (click)="viewEmail(email)"
                    class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button 
                    *ngIf="email.delivery?.state === 'ERROR' || !email.delivery"
                    (click)="retryEmail(email)"
                    class="text-green-600 hover:text-green-800">
                    <i class="fas fa-redo"></i>
                  </button>
                  <button 
                    (click)="openOutboxDeleteConfirm(email, $event)"
                    class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o de exclus√£o da mensagem (Outbox) -->
  <div *ngIf="showOutboxDeleteConfirm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" (click)="cancelOutboxDelete()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Excluir mensagem</h3>
      <p class="text-sm text-gray-600 mb-6">Tem certeza que deseja excluir esta mensagem da Caixa de Sa√≠da? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="flex justify-end gap-3">
        <button class="px-4 py-2 rounded-lg border border-gray-300" (click)="cancelOutboxDelete()">Cancelar</button>
        <button class="px-4 py-2 rounded-lg bg-red-600 text-white" (click)="confirmOutboxDelete()">Excluir</button>
      </div>
    </div>
  </div>

  <!-- API Tab -->
  <div *ngIf="!isLoading && activeTab === 'api'" class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Configura√ß√£o da API</h2>
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-600">Status:</span>
          <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded">
            <i class="fas fa-check-circle mr-1"></i>Ativa
          </span>
        </div>
      </div>
      
      <!-- Endpoint -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">
            <i class="fas fa-link mr-2 text-blue-500"></i>Endpoint para Novos Leads
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Use este endpoint para enviar novos leads diretamente para o seu kanban via API REST.
          </p>
          
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">URL do Endpoint:</span>
              <button 
                (click)="copyToClipboard(apiEndpoint)"
                class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-copy mr-1"></i>Copiar
              </button>
            </div>
            <code class="bg-blue-50 text-blue-800 text-sm p-2 rounded border block">
              {{ apiEndpoint }}
            </code>
          </div>
        </div>
        
        <!-- Token de Autentica√ß√£o -->
        <div class="p-6 border-b border-gray-200">
          <h4 class="text-md font-semibold text-gray-900 mb-2">
            <i class="fas fa-key mr-2 text-yellow-500"></i>Token de Autentica√ß√£o
          </h4>
          <p class="text-sm text-gray-600 mb-3">
            Inclua este token no header <code class="bg-gray-100 px-1 rounded">Authorization</code> de suas requisi√ß√µes.
          </p>
          
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Bearer Token:</span>
              <button 
                (click)="copyToClipboard(apiToken)"
                class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-copy mr-1"></i>Copiar
              </button>
            </div>
            <code class="bg-yellow-50 text-yellow-800 text-sm p-2 rounded border block font-mono">
              {{ apiToken }}
            </code>
          </div>
        </div>
        
        <!-- Exemplo de Requisi√ß√£o -->
        <div class="p-6">
          <h4 class="text-md font-semibold text-gray-900 mb-2">
            <i class="fas fa-code mr-2 text-green-500"></i>Exemplo de Requisi√ß√£o
          </h4>
          <p class="text-sm text-gray-600 mb-3">
            Exemplo de como enviar um novo lead via POST request:
          </p>
          
          <div class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto">
            <pre class="text-sm"><code>POST {{ apiEndpoint }}
Content-Type: application/json
Authorization: Bearer {{ apiToken }}

{{ apiExampleJson }}</code></pre>
          </div>
        </div>
      </div>
      
      <!-- Webhooks -->
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">
            <i class="fas fa-broadcast-tower mr-2 text-purple-500"></i>Webhooks (Em breve)
          </h3>
          <p class="text-sm text-gray-600">
            Receba notifica√ß√µes quando leads mudarem de fase, forem criados ou atualizados.
          </p>
        </div>
        
        <div class="p-6">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-construction text-4xl mb-3"></i>
            <h4 class="font-semibold mb-2">Funcionalidade em Desenvolvimento</h4>
            <p class="text-sm">Webhooks estar√£o dispon√≠veis em breve para integra√ß√£o avan√ßada.</p>
          </div>
        </div>
      </div>
      
      <!-- Documenta√ß√£o -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">
          <i class="fas fa-book mr-2"></i>Documenta√ß√£o da API
        </h3>
        <div class="space-y-3 text-sm text-blue-800">
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>M√©todo:</strong> POST para criar novos leads
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Content-Type:</strong> application/json obrigat√≥rio
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Autentica√ß√£o:</strong> Bearer token no header Authorization
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Campos obrigat√≥rios:</strong> companyName, contactName, contactEmail
            </div>
          </div>
          <div class="flex items-start space-x-3">
            <i class="fas fa-check-circle mt-0.5 text-blue-600"></i>
            <div>
              <strong>Resposta de sucesso:</strong> Status 201 com dados do lead criado
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile board: stages list + cards feed -->
  <div *ngIf="!isLoading && activeTab === 'kanban'" class="mobile-board">
    <div class="p-4 space-y-3">
      <!-- Mobile Search (moved from top nav) -->
      <div class="relative">
        <div class="flex gap-2 pb-2">
          <div class="relative flex-1 min-w-0">
            <input
              type="text"
              placeholder="Pesquisar..."
              [(ngModel)]="filterQuery"
              (ngModelChange)="onFilterQueryChange($event)"
              class="w-full pl-8 pr-20 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white"
              [class.border-blue-300]="filterQuery"
              [class.bg-white]="filterQuery">

            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>

            <!-- Filter Button -->
            <button
              (click)="toggleAdvancedFilters()"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1.5 rounded-full hover:bg-gray-100 transition-colors"
              [class.bg-blue-50]="hasActiveFilters() || showAdvancedFilters"
              [class.text-blue-600]="hasActiveFilters() || showAdvancedFilters"
              [class.text-gray-400]="!hasActiveFilters() && !showAdvancedFilters">
              <i class="fas fa-sliders-h text-xs"></i>
              <span *ngIf="getActiveDynamicFiltersCount() > 0 || filterOnlyMine"
                    class="absolute -top-1 -right-1 bg-blue-500 text-white rounded-full w-3 h-3 flex items-center justify-center text-[8px]">
                {{ (filterOnlyMine ? 1 : 0) + getActiveDynamicFiltersCount() }}
              </span>
            </button>

            <button
              *ngIf="filterQuery"
              (click)="filterQuery = ''; onFilterQueryChange('')"
              class="absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 p-1">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>

          <button *ngIf="hasActiveFilters()"
                  (click)="clearFilters()"
                  class="px-3 py-2 bg-red-100 text-red-700 rounded-full text-xs whitespace-nowrap hover:bg-red-200 transition-colors flex items-center gap-1 flex-shrink-0">
            <i class="fas fa-times"></i>
            Limpar
          </button>
        </div>
      </div>
      
      <!-- Filtros Avan√ßados (Campos Din√¢micos) -->
      <div *ngIf="showAdvancedFilters && availableFilterFields.length > 0" 
           class="bg-gray-50 rounded-lg p-4 space-y-3 border">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-medium text-gray-700 flex items-center gap-2">
            <i class="fas fa-filter text-purple-600"></i>
            Filtros por Campos
          </h4>
          <button (click)="showAdvancedFilters = false" 
                  class="text-gray-400 hover:text-gray-600 p-1">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-1 gap-3">
          <div *ngFor="let field of availableFilterFields" 
               class="flex items-center gap-3">
            <label class="text-sm text-gray-600 min-w-0 flex-1">
              {{ field.label }}
            </label>
            
            <!-- Campo de texto/email/tel -->
            <input *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'tel'"
                   type="text"
                   [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
                   [value]="getDynamicFilterValue(field.name)"
                   (input)="setDynamicFilter(field.name, $any($event.target).value)"
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">

            <!-- Campo de n√∫mero -->
            <input *ngIf="field.type === 'number'"
                   type="number"
                   [placeholder]="'Filtrar por ' + field.label.toLowerCase()"
                   [value]="getDynamicFilterValue(field.name)"
                   (input)="setDynamicFilter(field.name, $any($event.target).value)"
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">

            <!-- Campo de data -->
            <input *ngIf="field.type === 'date'"
                   type="date"
                   [value]="getDynamicFilterValue(field.name)"
                   (change)="setDynamicFilter(field.name, $any($event.target).value)"
                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">

            <!-- Checkbox -->
            <label *ngIf="field.type === 'checkbox'"
                   class="flex items-center gap-2 flex-1">
              <input type="checkbox"
                     [checked]="getDynamicFilterValue(field.name)"
                     (change)="setDynamicFilter(field.name, $any($event.target).checked)"
                     class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              <span class="text-sm text-gray-600">Apenas marcados</span>
            </label>
            
            <!-- Select/Radio/Temperatura (dropdown com op√ß√µes) -->
            <select *ngIf="field.type === 'select' || field.type === 'radio' || field.type === 'temperatura'"
                    [value]="getDynamicFilterValue(field.name)"
                    (change)="onDynamicFilterChange(field.name, $event)"
                    class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
              <option value="">Todos</option>
              <option *ngFor="let option of getFieldOptions(field)" [value]="option">
                {{ option }}
              </option>
            </select>
            
            <!-- Bot√£o para remover filtro espec√≠fico -->
            <button *ngIf="getDynamicFilterValue(field.name)"
                    (click)="removeDynamicFilter(field.name)"
                    class="p-1 text-red-400 hover:text-red-600 transition-colors">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
        
        <div *ngIf="getActiveDynamicFiltersCount() > 0" 
             class="text-xs text-purple-600 flex items-center gap-1 pt-2 border-t">
          <i class="fas fa-info-circle"></i>
          <span>{{ getActiveDynamicFiltersCount() }} filtro(s) ativo(s) por campos</span>
        </div>
      </div>
      
      <!-- Filter status indicator -->
      <div *ngIf="hasActiveFilters()" class="mt-2 text-xs text-blue-600 flex items-center gap-1">
        <i class="fas fa-filter"></i>
        <span>Filtros ativos</span>
        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
          {{ (filterQuery ? 1 : 0) + (filterOnlyMine ? 1 : 0) + getActiveDynamicFiltersCount() }}
        </span>
      </div>

      <!-- Stages as accordion list -->
      <div class="space-y-2">
        <div *ngFor="let column of columns" class="rounded-2xl border border-gray-200 bg-white">
          <button (click)="toggleMobileColumn(column.id!)" class="w-full px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-block w-3 h-3 rounded-full" [style.background-color]="column.color || '#22c55e'"></span>
              <div class="font-semibold text-gray-800">{{ column.name }}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500">{{ getLeadsForColumn(column.id!).length }}</span>
              <i class="fas" [class.fa-chevron-down]="!isMobileColumnOpen(column.id!)" [class.fa-chevron-up]="isMobileColumnOpen(column.id!)"></i>
            </div>
          </button>
          <div *ngIf="isMobileColumnOpen(column.id!)" class="px-4 pb-4">
            <div class="space-y-3">
              <div
                *ngFor="let lead of getLeadsForColumn(column.id!)"
                (click)="showLeadDetailModal(lead)"
                class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow">
                <div class="text-base font-bold text-gray-900 mb-1">{{ getLeadTitle(lead) }}</div>
                <div class="text-[13px] text-gray-500 mb-2" *ngIf="getLeadResponsibleName(lead)">
                  {{ getLeadResponsibleName(lead) }}
                </div>
                <div class="text-sm text-gray-700" *ngIf="lead.fields?.['contactName']">
                  <span class="uppercase tracking-wide text-gray-400 text-[11px]">NOME DO CONTATO</span><br>
                  {{ lead.fields['contactName'] }}
                </div>
                <div class="mt-3 flex items-center gap-5 text-xs text-gray-500">
                  <div class="flex items-center gap-1"><i class="far fa-comment"></i> 1</div>
                  <div class="flex items-center gap-1"><i class="far fa-clock text-orange-400"></i> {{ getDaysSince(lead.createdAt) }}d</div>
                  <div class="flex items-center gap-1"><i class="fas fa-history text-blue-500"></i> {{ getDaysSince(lead.movedToCurrentColumnAt) }}d</div>
                  <div class="flex items-center gap-1" *ngIf="getLeadDueDateLabel(lead)"><i class="far fa-calendar-check text-green-500"></i> {{ getLeadDueDateLabel(lead) }}</div>
                </div>
              </div>
              <div *ngIf="getLeadsForColumn(column.id!).length === 0" class="text-center text-gray-400 text-sm py-2">Nenhum registro nesta fase</div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div> <!-- closes mobile-board -->

  <!-- Floating Action Button (FAB) -->
  <button
    (click)="showCreateLeadModal()"
    [ngStyle]="{'background-color': getPrimaryColor()}"
    class="fixed bottom-6 right-6 z-40 md:hidden w-14 h-14 rounded-full shadow-lg hover:shadow-xl transition-all flex items-center justify-center">
    <i class="fas fa-plus text-white text-xl"></i>
  </button>
</app-main-layout>

<!-- Modal de Lead -->
<app-lead-modal 
  [ownerId]="ownerId"
  [boardId]="boardId"
  [columns]="columns"
  (leadCreated)="onLeadCreated()"
  (leadUpdated)="onLeadUpdated()"
  (closeModal)="onLeadUpdated()">
</app-lead-modal>

<!-- Modal de Coluna -->
<app-column-modal 
  [ownerId]="ownerId"
  [boardId]="boardId"
  [columns]="columns"
  (columnCreated)="onColumnCreated()"
  (columnUpdated)="onColumnUpdated()"
  (columnDeleted)="onColumnDeleted()"
  (closeModal)="onColumnUpdated()">
</app-column-modal>

<!-- Modal de Formul√°rio da Fase -->
<app-phase-form-modal 
  [ownerId]="ownerId"
  [boardId]="boardId"
  (formConfigSaved)="onPhaseFormConfigSaved()"
  (closeModal)="onPhaseFormConfigSaved()">
</app-phase-form-modal>

<!-- Modal de Detalhes do Lead -->
<app-lead-detail-modal 
  [ownerId]="ownerId"
  [boardId]="boardId"
  [columns]="columns"
  [users]="users"
  (leadUpdated)="onLeadUpdated()"
  (leadDeleted)="onLeadDeleted()"
  (closeModal)="onLeadUpdated()">
</app-lead-detail-modal>

<!-- Modal de Template -->
<app-template-modal 
  [ownerId]="ownerId"
  [boardId]="boardId"
  (templateSaved)="onTemplateSaved()"
  (closeModal)="onTemplateSaved()">
</app-template-modal>

<!-- Modal de Automa√ß√£o -->
<app-automation-modal
  *ngIf="showAutomationModal"
  [isVisible]="showAutomationModal"
  [automation]="selectedAutomation"
  [phases]="columns"
  [allowedTriggerTypes]="selectedPhaseIdForAutomations ? getAllowedTriggerTypesForPhase(selectedPhaseIdForAutomations) : null"
  [fixedPhaseId]="selectedPhaseIdForAutomations || null"
  [allowedTransitions]="flowConfig.allowed || {}"
  [emailTemplates]="emailTemplates"
  [users]="users"
  (closeModalEvent)="onCloseAutomationModal()"
  (saveAutomation)="onSaveAutomation($event)">
</app-automation-modal>

<!-- Modal de Hist√≥rico de Automa√ß√£o -->
<app-automation-history-modal
  [isVisible]="showHistoryModal"
  [automationId]="selectedAutomationForHistory?.id || ''"
  [automationName]="selectedAutomationForHistory?.name || ''"
  [ownerId]="ownerId"
  [boardId]="boardId"
  [leads]="leads"
  (closeModalEvent)="onCloseHistoryModal()">
</app-automation-history-modal>  