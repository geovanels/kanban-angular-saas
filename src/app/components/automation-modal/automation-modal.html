<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content modal-content-md p-6" (click)="$event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">{{ modalTitle }}</h2>
      <button class="text-gray-500 hover:text-gray-800 text-2xl" (click)="closeModal()">&times;</button>
    </div>
    
    <form [formGroup]="automationForm" (ngSubmit)="onSubmit()" class="modal-body space-y-6">
      <div class="border rounded-lg p-4">
        <h3 class="font-semibold text-md mb-3 text-gray-700">Gatilho (Quando...)</h3>
        <select formControlName="triggerType" class="w-full p-2 border rounded-md mb-2 bg-white" (change)="onTriggerTypeChange()">
          <ng-container *ngIf="!allowedTriggerTypes">
            <option value="new-lead-created">Criar novo registro (apenas fase inicial)</option>
            <option value="card-enters-phase">Um card entrou na fase</option>
            <option value="card-in-phase-for-time">Um card está na fase por um tempo</option>
            <option value="form-not-answered">Formulário da fase não respondido</option>
            <option value="sla-overdue">SLA da fase venceu</option>
          </ng-container>
          <ng-container *ngIf="allowedTriggerTypes">
            <option *ngIf="allowedTriggerTypes.includes('new-lead-created')" value="new-lead-created">Criar novo registro (apenas fase inicial)</option>
            <option *ngIf="allowedTriggerTypes.includes('card-enters-phase')" value="card-enters-phase">Um card entrou na fase</option>
            <option *ngIf="allowedTriggerTypes.includes('card-in-phase-for-time')" value="card-in-phase-for-time">Um card está na fase por um tempo</option>
            <option *ngIf="allowedTriggerTypes.includes('form-not-answered')" value="form-not-answered">Formulário da fase não respondido</option>
            <option *ngIf="allowedTriggerTypes.includes('sla-overdue')" value="sla-overdue">SLA da fase venceu</option>
          </ng-container>
        </select>
        
        <div [class.hidden]="!showTriggerPhase">
          <label for="triggerPhase" class="text-sm font-medium text-gray-700">Fase:</label>
          <ng-container *ngIf="!fixedPhaseId; else fixedPhase">
            <select formControlName="triggerPhase" class="w-full p-2 border rounded-md mt-1 bg-white">
              <option *ngFor="let phase of phases" [value]="phase.id">{{ phase.name }}</option>
            </select>
          </ng-container>
          <ng-template #fixedPhase>
            <div class="mt-1 p-2 bg-gray-50 border rounded text-sm">
              {{ getFixedPhaseName() }}
            </div>
          </ng-template>
        </div>
        
        <div [class.hidden]="!showTriggerTime" class="mt-2">
          <label for="triggerDays" class="text-sm font-medium text-gray-700" *ngIf="automationForm.get('triggerType')?.value === 'card-in-phase-for-time'">Por (dias):</label>
          <label for="triggerDays" class="text-sm font-medium text-gray-700" *ngIf="automationForm.get('triggerType')?.value === 'form-not-answered'">Aguardar (dias):</label>
          <input type="number" formControlName="triggerDays" min="1" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 3">
          <div class="text-xs text-gray-500 mt-1" *ngIf="automationForm.get('triggerType')?.value === 'form-not-answered'">
            Se, após esse prazo, nenhum campo do formulário da fase tiver sido preenchido, a automação será executada.
          </div>
        </div>
      </div>

      <div class="border rounded-lg p-4">
        <h3 class="font-semibold text-md mb-3 text-gray-700">Ações (Faça isso...)</h3>
        <div class="space-y-3">
          <div *ngFor="let action of automationForm.get('actions')?.value; let i = index" class="border rounded-lg p-3 bg-gray-50">
            <div class="flex justify-between items-start mb-2">
              <select [(ngModel)]="action.type" [ngModelOptions]="{standalone: true}" class="p-2 border rounded-md bg-white flex-1 mr-2">
                <option value="send-email">Enviar e-mail</option>
                <option value="move-to-phase">Mover para fase</option>
                <option value="assign-user">Atribuir usuário</option>
                <option value="add-note">Adicionar nota</option>
              </select>
              <button type="button" (click)="removeAction(i)" class="text-red-500 hover:text-red-700">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            
            <div [ngSwitch]="action.type" class="mt-2">
              <div *ngSwitchCase="'send-email'">
                <select [(ngModel)]="action.templateId" [ngModelOptions]="{standalone: true}" class="w-full p-2 border rounded-md bg-white">
                  <option value="">Selecione um template</option>
                  <option *ngFor="let template of emailTemplates" [value]="template.id">{{ template.name }}</option>
                </select>
              </div>
              
              <div *ngSwitchCase="'move-to-phase'">
                <select [(ngModel)]="action.phaseId" [ngModelOptions]="{standalone: true}" class="w-full p-2 border rounded-md bg-white">
                  <option value="">Selecione a fase de destino</option>
                  <option *ngFor="let phase of getAllowedPhasesForMoveAction()" [value]="phase.id">{{ phase.name }}</option>
                </select>
                <div class="text-xs text-gray-500 mt-1" *ngIf="fixedPhaseId || automationForm.get('triggerPhase')?.value">
                  Origem: {{ getFixedPhaseName() }}
                </div>
              </div>
              
              <div *ngSwitchCase="'assign-user'">
                <select [(ngModel)]="action.userId" [ngModelOptions]="{standalone: true}" class="w-full p-2 border rounded-md bg-white">
                  <option value="">Selecione um usuário</option>
                  <option *ngFor="let user of users" [value]="user.id">{{ user.name }}</option>
                </select>
              </div>
              
              <div *ngSwitchCase="'add-note'">
                <textarea [(ngModel)]="action.note" [ngModelOptions]="{standalone: true}" class="w-full p-2 border rounded-md" rows="3" placeholder="Digite a nota..."></textarea>
              </div>
            </div>
          </div>
        </div>
        
        <button type="button" (click)="addAction()" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm">
          <i class="fas fa-plus mr-2"></i>Adicionar Ação
        </button>
      </div>
      
      <div class="mt-6 flex justify-end gap-4">
        <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg" (click)="closeModal()">Cancelar</button>
        <button type="submit" [disabled]="!canSubmit()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400">
          {{ isEditing ? 'Atualizar' : 'Salvar' }} Automação
        </button>
      </div>
    </form>
  </div>
</div>
